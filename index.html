<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff-match-patch@1.0.5/index.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Comparison Tool</title>
    <style>

.header {
    background-color: white;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    padding: 16px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-title {
    flex-grow: 1;
    text-align: center;
}

.header-title h1 {
    font-size: 2rem; /* Smaller than the original 2.8rem */
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-fill-color: transparent;
    margin: 0; /* Remove margins */
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 1.2;
}

.header-buttons {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-shrink: 0;
}


.about-btn, .new-comparison-btn {
    background-color: white;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
    border-radius: 30px;
    padding: 10px 20px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-standard);
}

.about-btn:hover, .new-comparison-btn:hover {
    background-color: var(--primary-color);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(87, 6, 140, 0.3);
}

        .new-comparison-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-standard);
            margin-right: 15px;
            box-shadow: 0 3px 10px rgba(87, 6, 140, 0.2);
        }

        .new-comparison-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(87, 6, 140, 0.3);
        }

        .hidden {
            display: none !important;
        }
        
        .generate-report-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-standard);
            margin: 15px;
            box-shadow: 0 3px 10px rgba(87, 6, 140, 0.2);
        }
        
        .generate-report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(87, 6, 140, 0.3);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        :root {
            --primary-color: #57068c;
            --primary-dark: #330662;
            --primary-gradient: linear-gradient(135deg, #57068c 0%, #330662 100%);
            --secondary-color: #f8f9fa;
            --text-color: #333;
            --border-color: #e0e0e0;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --accent-light: #9c6fb6;
            --accent-lighter: #e5e1ea;
            --transition-standard: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --card-border: 1px solid rgba(230, 230, 240, 0.7);
            --font-primary: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .panel-content {
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.8;
    font-size: 1.1rem;
    text-align: justify;
    max-width: 85%;
    width: 85%;
    margin: 0 auto;
}
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-primary);
            background: #f0ecf8;
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 30px 20px 80px;
        }
        
        h1 {
            font-size: 2.8rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            margin-bottom: 2.5rem;
            text-align: center;
            font-weight: 700;
            letter-spacing: -0.03em;
            line-height: 1.2;
        }
        
        .upload-section {
            background-color: white;
            margin-bottom: 50px;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: var(--card-border);
            position: relative;
            overflow: hidden;
        }
        
        .upload-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--primary-gradient);
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition-standard);
            margin: 0;
            display: inline-block;
            box-shadow: none;
        }
        
        .tab-btn:hover {
            color: var(--primary-color);
            background-color: rgba(87, 6, 140, 0.05);
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: rgba(87, 6, 140, 0.05);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .example-card {
            background: white;
            border: var(--card-border);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: var(--transition-standard);
            position: relative;
            overflow: hidden;
        }
        
        .example-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary-gradient);
        }
        
        .example-card h4 {
            font-size: 1.3rem;
            color: var(--primary-dark);
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .example-author {
            font-size: 0.95rem;
            color: var(--accent-light);
            font-weight: 600;
            margin-bottom: 12px;
            font-style: italic;
        }
        
        .example-description {
            color: var(--text-color);
            line-height: 1.5;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        
        .example-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-standard);
            width: 100%;
            box-shadow: 0 3px 10px rgba(87, 6, 140, 0.2);
            margin: 0;
            display: block;
        }
        
        .example-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(87, 6, 140, 0.3);
        }
        
        .error {
            background-color: #fce8ea;
            color: #721c24;
            font-weight: 500;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border-left: 5px solid #d9534f;
        }
        
        .comparison-viewport {
            position: relative;
            width: 100%;
            overflow: hidden;
            height: 700px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: var(--card-border);
            background-color: white;
        }
        
        .comparison-slider {
            display: flex;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }
        
        .panel {
            width: 90%;
            min-width: 100%;
            max-width: 90%;
            height: 100%;
            padding: 30px 25px; /* Reduced from 40px to 25px on sides */
            background-color: white;
            overflow-y: auto;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .nav-arrow.left {
            left: 0px;
        }

        .nav-arrow.right {
            right: 5px;
        }
        
        .panel.diff-panel {
            background-color: #fafafa;
        }

       

        .diff-header h3 {
            margin-bottom: 0;
            flex-grow: 1;
        }

        @media (max-width: 768px) {
            .diff-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .new-comparison-btn {
                align-self: stretch;
                text-align: center;
            }
        }
        
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.6rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            z-index: 10;
            transition: var(--transition-standard);
        }
        
        .logo-container {
    height: 80px; /* Much smaller than before */
    display: flex;
    align-items: center;
    flex-shrink: 0;
}

.logo-container img {
    height: 100%;
    max-width: 240px; /* Limit width too */
    object-fit: contain;
}

.loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(2px);
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--accent-lighter);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.spinner-text {
    margin-top: 20px;
    color: var(--primary-dark);
    font-weight: 600;
    font-size: 1.1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}


       
        
        .nav-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .navigation-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-dark);
            z-index: 5;
            backdrop-filter: blur(10px);
        }
        
       /* Deletion styles */
.deletion {
    background-color: #ffebee;
    color: #c62828;
    text-decoration: line-through;
    padding: 2px 4px;
    border-radius: 3px;
    border-left: 3px solid #ef5350;
}

.diff-legend {
    margin-bottom: 20px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    font-size: 0.9rem;
}

.legend-item {
    margin-right: 20px;
    display: inline-block;
}

/* Addition styles */
.addition {
    background-color: #e8f5e8;
    color: #2e7d32;
    text-decoration: none;
    padding: 2px 4px;
    border-radius: 3px;
    border-left: 3px solid #66bb6a;
}

/* Level-specific styling */
.char-level {
    font-weight: 600;
    border-width: 1px;
}

.word-level {
    font-weight: 500;
    border-width: 2px;
}

.phrase-level {
    font-weight: 500;
    border-width: 2px;
    margin: 0 1px;
}

.sentence-level {
    font-weight: 400;
    border-width: 3px;
    margin: 2px 0;
    display: inline-block;
}


        .upload-area {
    text-align: center;
}

.file-input-container {
    border: 3px dashed var(--accent-light);
    border-radius: var(--border-radius);
    padding: 40px 20px;
    margin-bottom: 20px;
    transition: var(--transition-standard);
    cursor: pointer;
}

.file-input-container:hover {
    border-color: var(--primary-color);
    background-color: rgba(87, 6, 140, 0.02);
}

.upload-icon {
    font-size: 3rem;
    margin-bottom: 15px;
}

.upload-text strong {
    font-size: 1.2rem;
    color: var(--primary-dark);
    display: block;
    margin-bottom: 8px;
}

.upload-text p {
    color: var(--accent-light);
    margin: 0;
}

.file-list {
    background: var(--secondary-color);
    border-radius: var(--border-radius-sm);
    padding: 20px;
    margin-bottom: 20px;
    text-align: left;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
}

.file-item:last-child {
    border-bottom: none;
}

.file-name {
    font-weight: 600;
    color: var(--primary-dark);
}

.file-size {
    color: var(--accent-light);
    font-size: 0.9rem;
}

.remove-file {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    font-size: 0.8rem;
}

.compare-btn {
    background: var(--primary-gradient);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 15px 30px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-standard);
    box-shadow: 0 3px 10px rgba(87, 6, 140, 0.2);
}

.compare-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(87, 6, 140, 0.3);
}

@media (max-width: 768px) {
    .header {
        flex-direction: column;
        gap: 15px;
        padding: 20px 15px;
    }
    
    .header-title h1 {
        font-size: 1.8rem;
    }
    
    .logo-container {
        height: 35px;
    }
    
    .header-buttons {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 768px) {
    .panel {
        padding: 25px 20px; /* Even tighter on mobile */
    }
    
    .nav-arrow.left {
        left: 10px;
    }
    
    .nav-arrow.right {
        right: 10px;
    }
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.modal-content {
    background-color: white;
    margin: 7% auto;
    padding: 40px;
    border-radius: var(--border-radius);
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.25);
    width: 80%;
    max-width: 700px;
    animation: fadeIn 0.4s;
    position: relative;
}

.modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: var(--primary-gradient);
    border-top-left-radius: var(--border-radius);
    border-top-right-radius: var(--border-radius);
}

.modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    color: #777;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: var(--transition-standard);
    height: 40px;
    width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: #f5f5fa;
}

.modal-close:hover {
    color: var(--primary-dark);
    background-color: var(--accent-lighter);
    transform: rotate(90deg);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.modal-content h3 {
    color: var(--primary-color);
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 1.3rem;
    border-bottom: 1px solid var(--accent-lighter);
    padding-bottom: 8px;
}

.modal-content h4 {
    color: var(--primary-dark);
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: 1.1rem;
    font-weight: 600;
}

.modal-content ul {
    margin-left: 20px;
    margin-bottom: 15px;
}

.modal-content li {
    margin-bottom: 8px;
    line-height: 1.5;
}

.modal-content li strong {
    color: var(--primary-dark);
}

.citation {
    margin-top: 30px;
    padding: 15px;
    background-color: var(--secondary-color);
    border-left: 4px solid var(--primary-color);
    font-size: 0.9rem;
    font-style: italic;
}

.report-container {
    background: white;
    border-radius: var(--border-radius);
    padding: 30px;
    margin: 30px 0;
    box-shadow: var(--shadow);
    border: var(--card-border);
}

.report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
}

.report-title {
    font-size: 1.8rem;
    color: var(--primary-dark);
    font-weight: 700;
}

.report-toggle {
    display: flex;
    gap: 10px;
}

.toggle-btn {
    background: white;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
    border-radius: 20px;
    padding: 8px 16px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-standard);
}

.toggle-btn.active {
    background: var(--primary-gradient);
    color: white;
    border-color: transparent;
}

.revision-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.revision-table th {
    background: var(--primary-gradient);
    color: white;
    padding: 12px;
    text-align: left;
    font-weight: 600;
}

.revision-table td {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    text-align: center;
}

.revision-table tr:nth-child(even) {
    background-color: #f8f9fa;
}

.revision-table .row-label {
    font-weight: 600;
    background-color: #f0ecf8;
    text-align: left;
}

.total-row {
    background-color: #e5e1ea !important;
    font-weight: 700;
}

.detail-list {
    max-height: 400px;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
    border-radius: var(--border-radius-sm);
}

.revision-category {
    margin-bottom: 25px;
}

.category-title {
    font-size: 1.2rem;
    color: var(--primary-dark);
    font-weight: 600;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 2px solid var(--accent-light);
}

.revision-item {
    margin: 8px 0;
    padding: 8px;
    background: white;
    border-radius: 5px;
    border-left: 3px solid var(--accent-light);
}

.revision-item.addition {
    border-left-color: #66bb6a;
}

.revision-item.deletion {
    border-left-color: #ef5350;
}


.revision-text {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: #555;
    margin-top: 5px;
    padding: 5px;
    background: #f5f5f5;
    border-radius: 3px;
    word-break: break-word;
}

.stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    background: white;
    padding: 15px;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--border-color);
    text-align: center;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
}

.stat-label {
    color: var(--text-color);
    font-size: 0.9rem;
    margin-top: 5px;
}

.generate-report-btn {
    background: var(--primary-gradient);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-standard);
    margin: 20px auto;
    display: block;
    box-shadow: 0 3px 10px rgba(87, 6, 140, 0.2);
}

.generate-report-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(87, 6, 140, 0.3);
}

/* Annotation Styles */
.annotatable {
    cursor: pointer;
    position: relative;
}

.annotatable:hover {
    background-color: rgba(87, 6, 140, 0.1) !important;
    box-shadow: 0 0 0 2px rgba(87, 6, 140, 0.3);
}

/* Find and REPLACE the .has-annotation styles */
.has-annotation {
    border-bottom: 3px solid var(--primary-color);
    background-color: rgba(87, 6, 140, 0.08);
    padding: 2px 4px;
    border-radius: 3px;
    box-shadow: 0 0 0 2px rgba(87, 6, 140, 0.15);
}

.has-annotation::after {
    content: '📝';
    font-size: 1em;
    margin-left: 6px;
    opacity: 0.9;
    vertical-align: middle;
}

/* Add this new CSS rule for animation */
@keyframes annotationPulse {
    0%, 100% {
        box-shadow: 0 0 0 2px rgba(87, 6, 140, 0.15);
    }
    50% {
        box-shadow: 0 0 0 4px rgba(87, 6, 140, 0.25);
    }
}

.has-annotation {
    border-bottom: 3px solid var(--primary-color);
    background-color: rgba(87, 6, 140, 0.08);
    padding: 2px 4px;
    border-radius: 3px;
    box-shadow: 0 0 0 2px rgba(87, 6, 140, 0.15);
    animation: annotationPulse 2s ease-in-out infinite;
}

.has-annotation::after {
    content: '📝';
    font-size: 1em;
    margin-left: 6px;
    opacity: 0.9;
    vertical-align: middle;
}

.annotation-popup {
    position: fixed;
    background: white;
    border: 2px solid var(--primary-color);
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    z-index: 2000;
    max-width: 400px;
    min-width: 300px;
}

.annotation-popup h4 {
    margin: 0 0 15px 0;
    color: var(--primary-dark);
    font-size: 1.1rem;
}

.annotation-popup textarea {
    width: 100%;
    min-height: 100px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-sm);
    font-family: var(--font-primary);
    font-size: 0.95rem;
    resize: vertical;
}

.annotation-popup-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.annotation-save-btn, .annotation-cancel-btn, .annotation-delete-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: var(--transition-standard);
}

.annotation-save-btn {
    background: var(--primary-gradient);
    color: white;
    flex: 1;
}

.annotation-save-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(87, 6, 140, 0.3);
}

.annotation-cancel-btn {
    background: #e0e0e0;
    color: #333;
}

.annotation-delete-btn {
    background: #dc3545;
    color: white;
}

.annotation-display {
    margin-top: 5px;
    padding: 10px;
    background: #f8f9fa;
    border-left: 3px solid var(--primary-color);
    border-radius: 4px;
    font-size: 0.9rem;
    font-style: italic;
    color: #555;
}

.annotations-panel {
    background: white;
    padding: 25px;
    margin: 20px 0;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border: var(--card-border);
}

.annotations-panel h3 {
    color: var(--primary-dark);
    margin-bottom: 20px;
}

.annotation-item {
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: var(--border-radius-sm);
    border-left: 4px solid var(--primary-color);
}

.annotation-item-header {
    font-weight: 600;
    color: var(--primary-dark);
    margin-bottom: 8px;
}

.annotation-item-text {
    color: #555;
    margin-bottom: 8px;
}

.annotation-item-note {
    background: white;
    padding: 10px;
    border-radius: 4px;
    font-style: italic;
    color: #333;
}

.view-annotations-btn {
    background: white;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
    border-radius: 25px;
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-standard);
    margin: 15px;
    box-shadow: 0 3px 10px rgba(87, 6, 140, 0.2);
}

.view-annotations-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-2px);
}

/* Data Management Styles */
.data-manager {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.data-status {
    background: white;
    border: 2px solid var(--primary-color);
    border-radius: 25px;
    padding: 10px 20px;
    font-size: 0.9rem;
    color: var(--primary-dark);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    display: none;
    animation: slideIn 0.3s ease-out;
}

.data-status.show {
    display: block;
}

@keyframes slideIn {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.clear-data-btn {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 16px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    margin-top: 10px;
    transition: var(--transition-standard);
}

.clear-data-btn:hover {
    background: #c82333;
    transform: translateY(-2px);
}

.restore-banner {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border-left: 4px solid #4caf50;
    padding: 15px 20px;
    margin-bottom: 20px;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.restore-banner h4 {
    color: #2e7d32;
    margin: 0 0 8px 0;
    font-size: 1.1rem;
}

.restore-banner p {
    color: #1b5e20;
    margin: 0;
}

.restore-banner-buttons {
    margin-top: 12px;
    display: flex;
    gap: 10px;
}

.restore-btn, .dismiss-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: var(--transition-standard);
}

.restore-btn {
    background: #4caf50;
    color: white;
}

.restore-btn:hover {
    background: #43a047;
    transform: translateY(-2px);
}

.dismiss-btn {
    background: white;
    color: #2e7d32;
    border: 2px solid #4caf50;
}

.dismiss-btn:hover {
    background: #f1f8e9;
}

/* PDF/Print Styles */
.export-pdf-btn {
    background: var(--primary-gradient);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-standard);
    margin: 15px;
    box-shadow: 0 3px 10px rgba(87, 6, 140, 0.2);
}

.export-pdf-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(87, 6, 140, 0.3);
}

/* Print-specific styles */
@media print {
    /* Hide everything except the printable content */
    body * {
        visibility: hidden;
    }
    
    #printableContent,
    #printableContent * {
        visibility: visible;
    }
    
    #printableContent {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
    
    /* Hide navigation and UI elements */
    .header,
    .nav-arrow,
    .navigation-info,
    .generate-report-btn,
    .view-annotations-btn,
    .export-pdf-btn,
    .new-comparison-btn,
    .data-manager,
    .upload-section {
        display: none !important;
    }
    
    /* Optimize diff highlighting for print */
    .deletion {
        background-color: #ffebee !important;
        color: #c62828 !important;
        text-decoration: line-through;
        border-left: 3px solid #ef5350 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .addition {
        background-color: #e8f5e8 !important;
        color: #2e7d32 !important;
        border-left: 3px solid #66bb6a !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .has-annotation {
        background-color: rgba(87, 6, 140, 0.1) !important;
        border-bottom: 2px solid #57068c !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    /* Ensure colors print */
    * {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    /* Page breaks */
    .panel {
        page-break-after: always;
        page-break-inside: avoid;
    }
    
    .panel:last-child {
        page-break-after: auto;
    }
    
    .annotation-in-print {
        background-color: #f8f9fa !important;
        border-left: 4px solid #57068c !important;
        padding: 10px;
        margin: 10px 0;
        page-break-inside: avoid;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .annotation-in-print-header {
        font-weight: bold;
        color: #57068c !important;
        margin-bottom: 5px;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .annotation-in-print-text {
        font-style: italic;
        color: #333 !important;
        font-size: 0.9em;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    /* Legend for print */
    .print-legend {
        border: 2px solid #333 !important;
        padding: 15px;
        margin: 20px 0;
        background-color: #f8f9fa !important;
        page-break-inside: avoid;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .print-legend h3 {
        margin-top: 0;
        color: #57068c !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
}

.pdf-options-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.pdf-options-content {
    background-color: white;
    margin: 10% auto;
    padding: 30px;
    border-radius: var(--border-radius);
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.25);
    width: 90%;
    max-width: 500px;
    position: relative;
}

.pdf-options-content h3 {
    color: var(--primary-dark);
    margin-bottom: 20px;
}

.pdf-option {
    margin: 15px 0;
    padding: 15px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    transition: var(--transition-standard);
}

.pdf-option:hover {
    border-color: var(--primary-color);
    background-color: rgba(87, 6, 140, 0.05);
}

.pdf-option input[type="checkbox"] {
    margin-right: 10px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.pdf-option label {
    cursor: pointer;
    font-weight: 600;
    color: var(--primary-dark);
}

.pdf-option-description {
    margin-top: 5px;
    font-size: 0.9rem;
    color: #666;
    margin-left: 28px;
}

.pdf-buttons {
    display: flex;
    gap: 10px;
    margin-top: 25px;
}

.pdf-generate-btn, .pdf-cancel-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-standard);
}

.pdf-generate-btn {
    background: var(--primary-gradient);
    color: white;
}

.pdf-generate-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(87, 6, 140, 0.3);
}

.pdf-cancel-btn {
    background: #e0e0e0;
    color: #333;
}

.pdf-cancel-btn:hover {
    background: #d0d0d0;
}

    </style>
</head>


<body>

    <div id="loadingSpinner" class="loading-spinner">
        <div>
            <div class="spinner"></div>
            <div class="spinner-text">Analyzing drafts...</div>
        </div>
    </div>

    <header class="header">
        <div class="logo-container">
            <img src="https://i.imgur.com/iIODsNl.png" alt="NYU Logo" class="nyu-logo">
        </div>
        <div class="header-title">
            <h1>u even revise, bro?</h1>
        </div>
       <!-- Replace the existing header-buttons div with this: -->
<div class="header-buttons">
    <button class="about-btn" id="aboutButton">About</button>
    <button class="about-btn" id="clearDataButton" style="background: #dc3545; border-color: #dc3545; color: white;">Clear Data</button>
    <button class="new-comparison-btn hidden" id="headerNewComparisonBtn">New Comparison</button>
</div>
    </header>

    

    <div class="container">
        
        
        <div class="upload-section">
            <h2>Compare Drafts</h2>
            
            <div class="tab-container">
                <button class="tab-btn active" id="uploadTab">Upload Files</button>
                <button class="tab-btn" id="examplesTab">Example Essays from <i>Mercer Street</i></button>
            </div>
            
            <div id="uploadContent" class="tab-content active">
                <div class="upload-area">
                    <div class="file-input-container">
                        <label for="fileInput" class="file-input-label">
                            <div class="upload-icon">📁</div>
                            <div class="upload-text">
                                <strong>Choose files to compare</strong>
                                <p>Select multiple text files (.txt, .docx) or drag and drop them here</p>
                            </div>
                        </label>
                        <input type="file" id="fileInput" multiple accept=".txt,.docx,text/plain,application/vnd.openxmlformats-officedocument.wordprocessingml.document" style="display: none;">                    </div>
                    <div id="fileList" class="file-list" style="display: none;"></div>
                    <button id="compareFiles" class="compare-btn" style="display: none;">Compare Files</button>
                </div>
            </div>
            
            <div id="examplesContent" class="tab-content">
                <div class="examples-grid">
                    <div class="example-card" data-essay="essay1">
                        <h4>Ping! Panic! Repeat!</h4>
                        <p class="example-author">By Braden Ou</p>
                        <p class="example-description">An ethnographic study exploring smartphone use - view progression through five drafts</p>
                        <button class="example-btn">View All Drafts</button>
                    </div>

                    <div class="example-card" data-essay="essay2">
                        <h4><i>An excerpt from </i>Simulated Systems and the Limits of Intuitive Learning</h4>
                        <p class="example-author">By Srinivas Harish</p>
                        <p class="example-description">Examining how simulations shape our understanding of complex systems</p>
                        <button class="example-btn">View All Drafts</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="errorMessage" class="error" style="display: none;"></div>
        
        <div id="comparisonResults" style="display: none;">
            <div class="comparison-viewport">
                <div class="navigation-info" id="navigationInfo">Draft 1</div>
                <div class="nav-arrow left" id="leftArrow">←</div>
                <div class="nav-arrow right" id="rightArrow">→</div>
                <div class="comparison-slider" id="comparisonSlider">
                    <!-- Panels will be dynamically generated -->
                </div>
            </div>
        </div>
        <div id="revisionReportModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <span class="modal-close" id="reportModalClose">&times;</span>
                <h2 style="color: var(--primary-dark); margin-bottom: 20px;">Revision Analysis Report</h2>
                
                <div class="report-toggle" style="margin-bottom: 20px;">
                    <button class="toggle-btn active" id="tableViewBtn">Table View</button>
                    <button class="toggle-btn" id="detailViewBtn">Detailed List</button>
                </div>
                
                <div id="reportContent" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Report content will be dynamically generated here -->
                </div>
            </div>
        </div>

        <!-- Annotations Panel Modal -->
<div id="annotationsModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="modal-close" id="annotationsModalClose">&times;</span>
        <h2 style="color: var(--primary-dark); margin-bottom: 20px;">Revision Annotations</h2>
        <div id="annotationsContent">
            <!-- Annotations will be displayed here -->
        </div>
    </div>
</div>

<!-- PDF Export Options Modal -->
<div id="pdfOptionsModal" class="pdf-options-modal">
    <div class="pdf-options-content">
        <span class="modal-close" id="pdfOptionsClose">&times;</span>
        <h3>Export Options</h3>
        
        <div class="pdf-option" onclick="document.getElementById('includeAllDrafts').click()">
            <input type="checkbox" id="includeAllDrafts" checked>
            <label for="includeAllDrafts">Include all drafts</label>
            <div class="pdf-option-description">Export all draft versions and their comparisons</div>
        </div>
        
        <div class="pdf-option" onclick="document.getElementById('includeCurrentOnly').click()">
            <input type="checkbox" id="includeCurrentOnly">
            <label for="includeCurrentOnly">Current view only</label>
            <div class="pdf-option-description">Export only the currently visible draft or comparison</div>
        </div>
        
        <div class="pdf-option" onclick="document.getElementById('includeAnnotations').click()">
            <input type="checkbox" id="includeAnnotations" checked>
            <label for="includeAnnotations">Include annotations</label>
            <div class="pdf-option-description">Add your annotation notes to the exported document</div>
        </div>
        
        <div class="pdf-option" onclick="document.getElementById('includeLegend').click()">
            <input type="checkbox" id="includeLegend" checked>
            <label for="includeLegend">Include color legend</label>
            <div class="pdf-option-description">Add a legend explaining the color coding</div>
        </div>
        
        <div class="pdf-buttons">
            <button class="pdf-generate-btn" id="generatePdfBtn">Generate PDF</button>
            <button class="pdf-cancel-btn" id="pdfCancelBtn">Cancel</button>
        </div>
    </div>
</div>

<!-- Hidden printable content area -->
<div id="printableContent" style="display: none;"></div>

<!-- Data Manager -->
<div class="data-manager">
    <div id="dataStatus" class="data-status"></div>
</div>

<!-- Restore Banner (will be added dynamically) -->
    </div>
</div>


    <!-- About Modal -->
    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="aboutModalClose">&times;</span>
            <h3>What is this site for?</h3>
            <div>
                <p>Expert writers often say that writing is 99 percent revision. That's not just a comment on the difficulty of writing well. This idea also carries major implications for how writing skills are developed.</p>
                <br>
                <p>We believe people improve as writers when they learn to revise more strategically, more holistically, and more often. The purpose of this website is to draw writers attention to this most important part of the writing process. Our tool highlights large and small changes, and invites writers to reflect upon the nature, scope, goal, and impact of these changes. The goal is to help writers improve by revising more strategically, more holistically, and more often.</p>
                <br>
                <p>The "Mercer Street" tab offers a glimpse of the stages of revision that produced some exceptional essays by NYU undergraduates.</p>
                 <br>
                <h3>A research-backed approach</h3>
                 <br>
                <p>In 1980, Harvard researcher Nancy Sommers published a landmark study comparing the revision habits of novice and expert writers. Her findings revealed several fundamentally different approaches to and understandings of revision:</p>
                <br>
                <p><strong>For novice writers,</strong> revising involves mostly small changes, like word substitutions or addressing mechanical and grammatical errors. This minimalist approach to revision reflects novice's beliefs about the very purpose of writing. For most novices, writing is primarily a tool for expression--to "get down" our ideas on the page. This understanding of writing requires little use of revision.</p>
                <br>
                <p><strong>For experts,</strong> revision means much more. It can mean adding, deleting, or rewriting entire paragraphs. It can mean introducing new evidence and considering alternative perspectives. It can mean reinforcing, challenging or transforming one's initial assumptions and beliefs. This maximalist approach to revision reflects a profoundly different theory about the purpose of writing. For experts, writing isn't only a tool for expression but also exploration and discovery. They turn to writing to generate and better understand new ideas, and this demands revision, literally re-envisioning your ideas.</p>
                <br>
                <h3>How This Tool Helps</h3>
                 <br>
                <p>By examining the nature and scope of revisions, writers can identify current revision habits and patterns, identify opportunities for more substantial revision, and begin utilizing writing not merely to express ideas you already have, but also to expand, refine, challenge, and develop your thinking as well.</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPosition = 0;
        let totalPanels = 0;
        let currentEssay = null;
        
        // Function to show error message
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
        }
        
// Add this function anywhere in your script section (before generateAdvancedDiff is called)
function determineRevisionLevel(text) {
    // Normalize the text for consistent analysis
    const normalizedText = text.trim();
    
    // Define clear thresholds
    const words = (normalizedText.match(/\b\w+['']?\w*\b/g) || []).length;
    const sentences = (normalizedText.match(/[.!?]+[\s\n]+/g) || []).length;
    const hasMultipleParagraphs = /\n\s*\n/.test(normalizedText);
    
    // Clear hierarchical logic
    if (hasMultipleParagraphs || sentences >= 3) {
        return 'paragraph';
    } else if (sentences >= 1 && words >= 6) {
        return 'sentence';
    } else if (words >= 3) {
        return 'phrase';
    } else if (words >= 1) {
        return 'word';
    } else {
        return 'char'; // For punctuation-only changes
    }
}


        function generateAdvancedDiff(text1, text2) {
    const dmp = new diff_match_patch();
    
    // Configure for word-level boundaries
    dmp.Diff_Timeout = 2.0;
    dmp.Diff_EditCost = 6;
    
    // Perform initial diff
    const diffs = dmp.diff_main(text1, text2);
    
    // Clean up to respect word boundaries
    dmp.diff_cleanupSemantic(diffs);
    dmp.diff_cleanupEfficiency(diffs);
    
    let html = '';
    
    for (let i = 0; i < diffs.length; i++) {
        const [operation, text] = diffs[i];
        const level = determineRevisionLevel(text);
        
        if (operation === 0) { // Equal
            html += escapeHtml(text);
        } else if (operation === -1) { // Deletion
            html += `<span class="deletion ${level}-level">${escapeHtml(text)}</span>`;
        } else if (operation === 1) { // Addition
            html += `<span class="addition ${level}-level">${escapeHtml(text)}</span>`;
        }
    }
    
    return html;
}


// Helper to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}











// Replace the existing formatText function with this:
        function formatText(text) {
            // If the text already has paragraph breaks (double newlines), preserve them
            if (text.includes('\n\n')) {
                return text; // Return as-is, the paragraph structure is already there
            }
            
            // Otherwise, fallback to the old behavior for backward compatibility
            const sentences = text.match(/[^\.!?]+[\.!?]+/g) || [text];
            let formattedText = '';
            
            for (let i = 0; i < sentences.length; i++) {
                formattedText += sentences[i].trim();
                if ((i + 1) % 3 === 0 && i < sentences.length - 1) {
                    formattedText += '\n\n';
                } else if (i < sentences.length - 1) {
                    formattedText += ' ';
                }
            }
            
            return formattedText;
        }

        // File upload functionality
let uploadedFiles = [];

// Replace the existing handleFileUpload function with this corrected version:

function handleFileUpload(files) {
    const fileList = document.getElementById('fileList');
    const compareBtn = document.getElementById('compareFiles');
    
    for (let file of files) {
        if (file.type === 'text/plain' || 
            file.name.endsWith('.txt') || 
            file.name.endsWith('.docx') ||
            file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
            uploadedFiles.push(file);
            addFileToList(file);
        } else {
            showError(`File "${file.name}" is not supported. Please upload .txt or .docx files only.`);
        }
    }
    
    if (uploadedFiles.length > 0) {
        fileList.style.display = 'block';
        
        // Fixed: Show the compare button when 2 or more files are uploaded
        if (uploadedFiles.length >= 2) {
            compareBtn.style.display = 'block';
        } else {
            compareBtn.style.display = 'none';
            showError('Please upload at least 2 files to compare.');
        }
    }

     // Save files to localStorage
     if (uploadedFiles.length > 0) {
        saveFileContents(uploadedFiles);
    }
}

function addFileToList(file) {
    const fileList = document.getElementById('fileList');
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
        <div>
            <div class="file-name">${file.name}</div>
            <div class="file-size">${(file.size / 1024).toFixed(1)} KB</div>
        </div>
        <button class="remove-file" onclick="removeFile('${file.name}')">×</button>
    `;
    fileList.appendChild(fileItem);
}

function removeFile(fileName) {
    uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
    refreshFileList();
}

// Also ensure the refreshFileList function properly handles the button visibility:
function refreshFileList() {
    const fileList = document.getElementById('fileList');
    const compareBtn = document.getElementById('compareFiles');
    
    fileList.innerHTML = '';
    
    if (uploadedFiles.length === 0) {
        fileList.style.display = 'none';
        compareBtn.style.display = 'none';
    } else {
        uploadedFiles.forEach(addFileToList);
        fileList.style.display = 'block';
        // Show compare button only when 2 or more files are uploaded
        compareBtn.style.display = uploadedFiles.length >= 2 ? 'block' : 'none';
    }
}

async function compareUploadedFiles() {
    // Show spinner
    document.getElementById('loadingSpinner').style.display = 'flex';
    
    if (uploadedFiles.length < 2) {
        document.getElementById('loadingSpinner').style.display = 'none';
        showError('Please upload at least 2 files to compare.');
        return;
    }
    
    try {
        const fileContents = [];
        for (let file of uploadedFiles) {
            const text = await readFileContent(file);
            const fileName = file.name.replace(/\.(txt|docx)$/, '');
            fileContents.push({
                version: fileName,
                text: text
            });
        }
        
        const uploadedEssay = {
            title: "Uploaded Files Comparison",
            author: "User Upload", 
            description: "Comparison of uploaded text files",
            drafts: fileContents
        };
        
        currentEssay = uploadedEssay;
        const panelInfo = createPanels(uploadedEssay);
        totalPanels = panelInfo.length;
        currentPosition = 0;
        
        // Hide upload section
        const uploadSection = document.querySelector('.upload-section');
        if (uploadSection) uploadSection.classList.add('hidden');
        
        const comparisonResults = document.getElementById('comparisonResults');
        comparisonResults.style.display = 'block';
        updateSliderPosition();
        updateNavigationInfo(panelInfo);
        
        setupNewComparisonButton();
        
        // Hide spinner - moved to end
        document.getElementById('loadingSpinner').style.display = 'none';
        
    } catch (error) {
        document.getElementById('loadingSpinner').style.display = 'none';
        showError('Error reading files: ' + error.message);
    }

        // Save state after successful comparison
        saveState();
}
    async function readFileContent(file) {
    return new Promise((resolve, reject) => {
        if (file.name.endsWith('.docx') || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
            // Handle .docx files with mammoth
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const arrayBuffer = e.target.result;
                    const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                    resolve(result.value);
                } catch (error) {
                    reject(new Error('Failed to read .docx file: ' + error.message));
                }
            };
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsArrayBuffer(file);
        } else {
            // Handle .txt files
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsText(file);
        }
    });
}


        
        // Sample essay data with more realistic content
        const exampleEssays = {
            essay1: {
                title: "Ping! Panic! Repeat!",
                author: "Braden Ou",
                description: "An ethnographic study exploring smartphone use",
                drafts: [
                { 
                version: "Draft 1", 
                text: `Ping! Panic! Repeat!
Picture a late-night subway ride on the F subway line: fluorescent lights flicker overhead, a half-empty car rattles through the tunnel, and every few seconds somebody's phone buzzes. "Armed robbery—Upper East Side," flashes one push notification. "Man shoved onto tracks in Midtown," warns another. A teenager beside you scrolls an endless reel of grainy security-camera clips, often with some unsuspecting victim about to be assaulted; a middle-aged commuter checks the Citizen app, its red map pins pulsing like fresh wounds across the city grid. Even the PA system crackles with an "If you see something, say something" reminder. Surrounded by screens and alerts, the train car feels poised for disaster, and instinctively, you tighten your grip on the handrail, eyes darting toward every stranger who wanders too close.

Yet that sense of imminent danger is becoming mostly a digital mirage. According to the NYPD's first-quarter 2025 report, subway crime is down double digits, with zero murders—the safest start to a year in at least seven years and among the lowest violent-crime tallies ever recorded on the system (New York Daily News). What makes the ride feel dangerous isn't an epidemic of violence but the smartphone in every pocket, collapsing the city's rare worst moments into a relentless real-time news crawl. The very device that lets us summon help also directs each tragedy straight into our brains, inflating our perceived risk on an otherwise routine commute. This paradox creates an interesting question: How does the tension between smartphones' designed purpose of connection and their more often actual use of distraction and social shielding reflect more profound anxieties in modern society? To investigate this, I spent three weeks in February of 2025 riding numerous subway lines and bus routes, documenting episodes of public phone use.

Smartphones were never meant to play this role. When Steve Jobs unveiled the iPhone in 2007, he called it "a widescreen iPod with touch controls; a revolutionary mobile phone; and a breakthrough Internet communications device" (Pangambam). In the years since, ownership of this powerful device has soared to 91 percent of American adults. (Pew Research Center). Today, it constructs personal media bubbles that double as social shields, offering connection while encouraging retreat.

Technology sociologist Sherry Turkle, a professor of social studies of science and technology at Massachusetts Institute of Technology, has coined the term "tethered self," which illustrates this phenomenon. According to Turkle, smartphones have created a state of society where we are "always-on/always-on-you," a reference to how smartphones are always readily available to us as a society (Turkle 121). This "tethered self" creates a world where we maintain a constant psychological readiness for the connections that matter to us digitally. But many people embrace this "tethered self," actively choosing to escape into this digital world even if not called upon by their connections in the digital world. This, as Turkle continues, creates a "liminal space between the physical real and its digital lives on multiple screens" (Turkle 122). We are never fully here, yet never fully elsewhere either.

Turkle's concept describes exactly what my field notes expose: riders feel safest the moment they retreat into a device that simultaneously stokes their fear. Riding the M103 down Third Avenue, I watched two friends chat easily. They had a nice, long conversation, talking about their daily lives, with neither of them holding a smartphone at all. After a while, it seemed like one of the friends had reached his stop. He said goodbye to his friend and left the bus, leaving the other friend to ride alone. The moment the remaining rider was alone, he cast a cautious glance around, made brief eye contact with me, and fled into his phone. When I made eye contact, I also felt a similar urge, pulling out my phone to start playing video games on it. Interestingly enough, this seems to indicate that this urge is contagious in a sense. In my mind, eye contact with a stranger was uncomfortable, and I felt a need to intentionally distract myself with a phone to try to relieve myself of the awkward situation. I imagine that the stranger also felt the same way, suddenly feeling a void that was once filled with conversation with his friend. Part of this does have a cultural backing to it; there are plenty of folktales on the New York City subway about how making momentary eye contact with a stranger resulted in an altercation. As such, it has become a social norm for people to actively avoid eye contact, and the smartphone has been repurposed as a tool for this use. I could be doing absolutely nothing on my phone, just staring at the weather for the hundredth time, yet it creates the sense of safety that I will not accidentally stare right into someone's eyes, possibly creating an unsettling and tense situation. This incident revealed a profound irony: devices engineered to enhance connection have become tools that help us avoid human contact. The smartphone's design makes it an ideal shield—its screen demands attention and signals busyness to others, creating a socially acceptable way to opt out of physical presence while maintaining the appearance of productivity.  This is the crux of Turkle's point about technology: We have become so attached to our tethers that not only do the tethers hold us tightly, but we also hold the tethers tightly as well.

This protective shield extends to more threatening situations as well. In another one of my observations, I noticed that there was a woman in a subway station, and a man approached her asking for money. As I watched this interaction unfold, I could see his extended hand and hear his repeated requests for "spare change" and mentions of homelessness—common signs of panhandling in NYC. She started quickly walking away while looking at her phone, very intentionally trying not to look at him while moving herself towards the station's main area, likely to find more people in case the man was to cause her any harm. What I found really interesting was that the woman was on her phone the whole time. She stared at it the whole time, even though the more probable threat was the person behind her rather than her smartphone. I feel like it would've been much smarter for her to look at the person and make sure he wasn't going to endanger her. I suppose there is the chance that staring at the man would have further antagonized him, but in a case where someone is already following you in an almost empty station, I think that's a risk worth taking to protect yourself. Staring at your phone, even superficially by not paying attention to the content on it, still heavily limits her ability to react in case things escalate. Once again, another example of being not fully here, but not really being fully elsewhere either.

Interestingly, this behavior reveals a psychological protective mechanism. One reason why I think she might be doing this is because her mind wanted to actively distract herself to avoid the trauma that she is actually being stalked. The human mind seems to have an ability to forcibly block things that it does not want to think about by moving you to somewhere else mentally, spending your mind's resources associating yourself with another environment. Having fewer resources in your mind telling you how bad the current situation is limits the total pain it could cause you, according to a study done by Dr. Denise M. Sloan, an associate director at the National Center for PTSD (Swaim 5). Here is another example of the smartphone functioning as a social shield – providing a visual barrier, a reason not to engage, and an escape portal from an uncomfortable reality. Her behavior demonstrates what Turkle calls the "tethered self" – being physically present but mentally elsewhere. The woman's smartphone allowed her to psychologically escape a dangerous situation by tethering mind to a safer digital space, placing herself within the liminal space of reality and the digital world. The dual existence of these two worlds plays an interesting role in this situation: while her body remained vulnerable in the subway station, her attention ran away from the threat. This demonstrates how smartphones can function as psychological protection devices, not just from potential physical threats but from the emotional discomfort of confrontation. This protective function was never explicitly designed into smartphones, yet it has become one of their most common uses in public spaces.

But here lies the central paradox of smartphone use in urban spaces. If phones can soothe discomfort, they just as readily stoke it. In the moment, a vibrating phone offers a reassuring ritual: glancing down lets us escape awkward eye contact, confirm a train's ETA, or signal to friends that we're still alive in the tunnel dead zone. Yet the very streams that calm us also keep our anxiety circuits primed. Citizen, Twitter, and 24-hour push notifications bombard New Yorkers with every robbery, shove, and scuffle, however rare. Each red banner lights up the brain's threat-detection pathways, triggering the same cortisol spike we'd feel if the incident were unfolding a few feet away. Doom-scrolling further reinforces the loop: every swipe delivers fresh jolts of negative stimulus and a hit of dopamine for "staying informed," so users oscillate between dread and reward. The result is what researchers call hyper-vigilant fatigue: the body's fight-or-flight switch remains half-pressed, so even the ordinary clang of closing doors feels ominous (Gotter). In a city that never sleeps, the phone that never rests ensures anxiety never fully powers down.

The gap between how smartphones were designed and how they're actually used raises important questions for technology designers. When Jobs unveiled the iPhone, he emphasized productivity, entertainment, and communication, not social avoidance or psychological self-protection, a common norm in the confines of New York City. This disconnect is a great example of what Langdon Winner, the Chair of Humanities and Social Studies at Rensselaer Polytechnic Institute, described as "technological somnambulism" – a societal tendency to sleepwalk through technological changes that fundamentally reshape our societal activities. As Winner argues, "technologies are not merely aids to human activity, but also powerful forces acting to reshape that activity and its meaning" (Winner 4). We adopt smartphones without fully examining their side effects, and we only stumble into how deeply they have altered our social behaviors and norms. Yet my observations suggest these unintended functions fulfill genuine human needs in an increasingly crowded, stimulating world. How might technology be designed differently if engineers acknowledged these actual usage patterns? What ethical responsibility do designers have when creating tools that so profoundly shape social behavior?

My observations reveal that smartphones have evolved beyond their designers' intentions into sophisticated social tools that help manage modern anxieties. The gap between designed purpose and actual use reflects our paradoxical desires: we crave both connection and isolation, productivity and distraction, social engagement and personal retreat. This causes us to be increasingly uncomfortable with our social moments and the humanity and vulnerability such interactions require. This tension places significant ethical responsibility on technology designers, who must recognize that their creations don't simply serve stated functions but actively reshape social norms and human behavior. Understanding this relationship requires moving beyond simple narratives of addiction or convenience to recognize how we actively repurpose technology to manage complex social realities. As we design future technologies, acknowledging how these tensions are developed might help create tools that better align with genuine human needs rather than inadvertently amplifying our social anxieties.`
            },
            { 
    version: "Draft 2", 
    text: `Ping! Panic! Repeat!

Picture a late-night subway ride on the F subway line: fluorescent lights flicker overhead, a half-empty car rattles through the tunnel, and every few seconds somebody's phone buzzes. "Armed robbery—Upper East Side," flashes one push notification. "Man shoved onto tracks in Midtown," warns another. A teenager beside you scrolls an endless reel of grainy security-camera clips, often with some unsuspecting victim about to be assaulted; a middle-aged commuter checks the Citizen app, its red map pins pulsing like fresh wounds across the city grid. Even the PA system crackles with an "If you see something, say something" reminder. Surrounded by screens and alerts, the train car feels poised for disaster, and instinctively, you tighten your grip on the handrail, eyes darting toward every stranger who wanders too close.

Yet that sense of imminent danger is becoming mostly a digital mirage. According to the NYPD's first-quarter 2025 report, subway crime is down double digits, with zero murders—the safest start to a year in at least seven years and among the lowest violent-crime tallies ever recorded on the system (New York Daily News). If crime is at historic lows, what explains the persistent feeling of danger that permeates subway cars? The answer may lie in the device nearly every rider carries: Smartphones. While smartphones were designed to connect us and keep us informed, their actual use in public spaces reveals a more complex aspect of how we navigate modern urban anxieties. To investigate this, I spent three weeks in February of 2025 riding numerous subway lines and bus routes, documenting episodes of public phone use.

The patterns I observed would have surprised even Steve Jobs, who envisioned this device bringing people together rather than helping them avoid each other. When Jobs unveiled the iPhone in 2007, Jobs spoke of seamless communication and instant connection (Pangambam). Today, it constructs personal media bubbles that double as social shields, offering connection while encouraging retreat.

Technology sociologist Sherry Turkle, a professor of social studies of science and technology at Massachusetts Institute of Technology, has coined the term "tethered self," which illustrates this phenomenon. This "tethered self" creates a world where we maintain a constant psychological readiness for the connections that matter to us digitally. According to Turkle, smartphones have created a state of society where we are "always-on/always-on-you," a reference to how smartphones are always readily available to us as a society (Turkle 121). But many people embrace this "tethered self," actively choosing to escape into this digital world even if not called upon by their connections in the digital world. This, as Turkle continues, creates a "liminal space between the physical real and its digital lives on multiple screens" (Turkle 122). We are never fully here, yet never fully elsewhere either.

This liminal space helps explain what I observed in my field notes: riders repeatedly chose digital retreat over physical engagement when faced with social uncertainties. The tether acts as a quick way for users to create psychological buffers, a protection against the demands of human interaction. Riding the M103 down Third Avenue, I watched two friends chat easily. They had a nice, long conversation, talking about their daily lives, with neither of them holding a smartphone at all. After a while, it seemed like one of the friends had reached his stop. He said goodbye to his friend and left the bus, leaving the other friend to ride alone. The moment the remaining rider was alone, he cast a cautious glance around, made brief eye contact with me, and fled into his phone. When I made eye contact, I also felt a similar urge, pulling out my phone to start playing video games. This simultaneous retreat made me wonder whether digital avoidance might be socially contagious. Maybe when one person withdraws into their device, it signals to others that the digital escape is both accepted and expected. In my mind, eye contact with a stranger was uncomfortable, and I felt a need to intentionally distract myself with a phone to try to relieve myself of the awkward situation. I imagine that the stranger also felt the same way, suddenly feeling a void that was once filled with conversation with his friend. Part of this does have a cultural backing to it; there are plenty of folktales on the New York City subway about how making momentary eye contact with a stranger resulted in an altercation. As such, it has become a social norm for people to actively avoid eye contact, and the smartphone has been repurposed as a tool for this use. I could be doing absolutely nothing on my phone, just staring at the weather for the hundredth time, yet it creates the sense of safety that I will not accidentally stare right into someone's eyes, possibly creating an unsettling and tense situation. This incident revealed a profound irony: devices engineered to enhance connection can also become tools that dissuade it just as easily. The smartphone's design makes it an ideal shield—its screen demands attention and signals busyness to others, creating a socially acceptable way to opt out of physical presence while maintaining the appearance of productivity. This is the crux of Turkle's point about technology: We have become so attached to our tethers that not only do the tethers hold us tightly, but we also hold the tethers tightly as well.

This protective shield extends to more threatening situations as well. In another one of my observations, I noticed that there was a woman in a subway station, and a man approached her asking for money. As I watched this interaction unfold, I could see his extended hand and hear his repeated requests for "spare change" and mentions of homelessness—common signs of panhandling in NYC. She started quickly walking away while looking at her phone, keeping her eyes fixed on the screen rather than looking at him while moving herself towards the station's main area, where more people were present. What I found really interesting was that the woman was on her phone the whole time. She stared at it the whole time, even though the more probable threat was the person behind her rather than her smartphone. I feel like it would've been much smarter for her to look at the person and make sure he wasn't going to endanger her. I suppose there is the chance that staring at the man would have further antagonized him, but in a case where someone is already following you in an almost empty station, I think that's a risk worth taking to protect yourself. Staring at your phone, even superficially by not paying attention to the content on it, still heavily limits her ability to react in case things escalate. Once again, another example of being not fully here, but not really being fully elsewhere either.

Interestingly, this behavior reveals a psychological protective mechanism. One reason why I think she might be doing this is because her mind wanted to actively distract herself to avoid the trauma that she is actively being followed. The human mind has the ability to forcibly block things it does not want to think about by mentally shifting you to another place, thereby allocating your mental resources to associate with a different environment. Her mind may have been using what researchers call "peritraumatic dissociation," which is a psychological response that can include emotional numbness and altered perception during stressful events, according to an observational study done by analyzing responses to standardized questionnaires by Dr. Denise M. Sloan, an associate director at the National Center for PTSD (Swaim 5). Here is another example of the smartphone functioning as a social shield – providing a visual barrier, a reason not to engage, and an escape portal from an uncomfortable reality. Her behavior demonstrates what Turkle calls the "tethered self" – being physically present but mentally elsewhere. The woman's smartphone allowed her to psychologically escape a dangerous situation by tethering her mind to a safer digital space, placing herself within the liminal space of reality and the digital world. The dual existence of these two worlds plays an interesting role in this situation: while her body remained vulnerable in the subway station, her attention ran away from the threat. This situation demonstrates how smartphones can function as psychological protection devices, not just from potential physical threats but from the emotional discomfort of confrontation. This protective function was never explicitly designed into smartphones, yet it has become one of their most common uses in public spaces.

But this protective function shows a troubling irony. While phones shield us from immediate discomfort, they also amplify our broader anxieties about urban danger. These devices simultaneously serve as shields from present realities and sources for the constant stream of crime alerts, push notifications, and security footage that make public spaces feel perpetually unsafe (Riddell, 34). This creates the central paradox of smartphone use in urban spaces. If phones can soothe discomfort, they just as readily stoke it. In the moment, a vibrating phone offers a reassuring ritual: glancing down lets us escape awkward eye contact, confirm a train's ETA, or signal to friends that we're still alive in the tunnel dead zone. Yet the very streams that calm us also keep our anxiety circuits primed. Citizen, Twitter, and 24-hour push notifications bombard New Yorkers with every robbery, shove, and scuffle, however rare. Each red banner lights up the brain's triggers the same stress response we'd feel if the incident were unfolding a few feet away (Intravia). Doom-scrolling further reinforces the loop: every swipe delivers fresh jolts of negative stimulus and a hit of dopamine for "staying informed," so users oscillate between dread and reward (Dolgoff). The result is what experts like Dr. Timothy J. Legg, adjunct professor in the Pepperdine Graduate School of Education and Psychology, call hyper-vigilant fatigue: the body's fight-or-flight switch remains half-pressed, so even the ordinary clang of closing doors feels ominous (Gotter). In a city that never sleeps, the phone that never rests ensures anxiety never fully powers down.

The gap between how smartphones were designed and how they're actually used raises important questions for technology designers. When Jobs unveiled the iPhone, he emphasized productivity, entertainment, and communication, not social avoidance or psychological self-protection, a common norm in the confines of New York City. This disconnect is a great example of what Langdon Winner, the Chair of Humanities and Social Studies at Rensselaer Polytechnic Institute, described as "technological somnambulism" – a societal tendency to sleepwalk through technological changes that fundamentally reshape our societal activities. As Winner argues, "technologies are not merely aids to human activity, but also powerful forces acting to reshape that activity and its meaning" (Winner 4). Published in 1973, Winner cites numerous archaic examples, but clearly he was a man ahead of his time, as these thoughts apply equally well to the world we live in today and the newest technologies that actively change society. We adopted smartphones without fully examining their side effects, and we only stumbled into how deeply they have altered our social behaviors and norms. Yet my observations suggest these unintended functions fulfill genuine human needs in an increasingly crowded, stimulating world. How might technology be designed differently if engineers acknowledged these actual usage patterns? What ethical responsibility do designers have when creating tools that so profoundly shape social behavior?

My observations suggest that smartphones have evolved beyond their designers' intentions into sophisticated social tools that help manage modern anxieties. The gap between designed purpose and actual use reflects our paradoxical desires: we crave both connection and isolation, productivity and distraction, social engagement and personal retreat. This causes us to be increasingly uncomfortable with our social moments and the humanity and vulnerability such interactions require. This tension places significant ethical responsibility on technology designers, who must recognize that their creations don't simply serve stated functions but actively reshape social norms and human behavior. Understanding this relationship requires moving beyond simple narratives of addiction or convenience to recognize how we actively repurpose technology to manage complex social realities. As we design future technologies, acknowledging how these tensions are developed might help create tools that better align with genuine human needs rather than inadvertently amplifying our social anxieties.`
},
{ 
    version: "Draft 3", 
    text: `Ping! Panic! Repeat!

Picture a late-night subway ride on the F subway line: fluorescent lights flicker overhead, a half-empty car rattles through the tunnel, and every few seconds somebody's phone buzzes. "Armed robbery—Upper East Side," flashes one push notification. "Man shoved onto tracks in Midtown," warns another. A teenager beside you scrolls an endless reel of grainy security-camera clips, often with some unsuspecting victim about to be assaulted. A middle-aged commuter checks the Citizen app, its red map pins pulsing like fresh wounds across the city grid. Even the PA system crackles with an "if you see something, say something" reminder. Surrounded by screens and alerts, the train car feels poised for disaster, and instinctively, you tighten your grip on the handrail, eyes darting toward every stranger who wanders too close.

Yet that sense of danger may be a digital mirage. According to the NYPD's first-quarter 2025 report, subway crime is down double digits, with zero murders—the safest start to a year in at least seven years and among the lowest violent-crime tallies ever recorded on the system (New York Daily News). Maybe can make an ordinary ride feel dangerous is not an epidemic of violence in the smartphones in our pocket. To investigate this possibility, I spent three weeks in February of 2025 riding numerous subway lines and bus routes, documenting episodes of public phone use. More broadly, I began to see that while smartphones were designed to connect us and keep us informed, their actual use in public spaces also reveals their complex role in how we navigate modern urban anxieties.

The patterns I observed might have surprised even Steve Jobs, the founder of Apple, who envisioned his smartphone bringing people together rather than helping them avoid each other. When Jobs unveiled his ideas for the iPhone in 2007, Jobs spoke of seamless communication and instant connection (Pangambam). But that's not the way I saw smartphones being used on transit. There, I began to think of them as constructing what I call "social shields," digital barriers that allow users to avoid physical interactions in a socially acceptable way, the antithesis to Job's vision. By staring at a screen, users can avoid eye contact, deflect unwanted conversations, and, perhaps, create psychological distance from their immediate environment while maintaining the appearance of productivity.

My idea of a "social shield" emerged from what technology sociologist Sherry Turkle coined the "tethered self" in her essay "Always-On/Always-On-You: The Tethered Self." Writing in 2008, just one year after the release of the iPhone, Turkle predicted with remarkable precision about how these devices could reshape social life. She described how smartphones were creating a state of society where we are "always-on/always-on-you," a reference to how smartphones are always readily available to us as a society (Turkle 121). Turkle, a professor of social studies of science and technology at Massachusetts Institute of Technology, describes how our "tethered self" can maintain a constant psychological readiness for the connections that matter to us digitally (121). The smartphone creates a "liminal space between the physical real and its digital lives on multiple screens" (122). We are never fully here, yet never fully elsewhere either.

Based on my observations, many people embrace this "tethered self," actively choosing to turn to their digital worlds during moments of social discomfort, regardless of whether they have actual messages or notifications to address. Riding the M103 down Third Avenue, I watched two friends chat easily. They had a nice, long conversation, talking about their daily lives, with neither of them holding a smartphone at all. After a while, it seemed like one of the friends had reached his stop. He said goodbye to his friend and left the bus, leaving the other friend to ride alone. The moment the remaining rider was alone, he cast a cautious glance around, made brief eye contact with me, and fled into his phone. When I made eye contact, I also felt a similar urge, pulling out my phone to start playing video games. Maybe when one person withdraws into their device, it signals to others that the digital escape is both accepted and expected. In my mind, eye contact with a stranger was uncomfortable, and I felt a need to intentionally distract myself with a phone to try to relieve myself of the awkward situation. Maybe the stranger felt the same way.

The tether can act as more than a quick way for users to create psychological buffers. On the subway, the smartphones are also repurposed as a means to actively avoid eye contact. I could be doing absolutely nothing on my phone, just staring at the weather for the hundredth time, yet it creates the sense of safety that I will not accidentally stare right into someone's eyes, possibly creating an unsettling and tense situation. There's a cultural backing behind my behavior; there are plenty of folktales on the New York City subway about how making momentary eye contact with a stranger resulted in an altercation. Ironically, devices engineered to enhance connection can also become tools that dissuade it just as easily. The smartphone's design makes it an ideal shield—its screen demands attention and signals busyness to others, creating a socially acceptable way to opt out of physical presence while maintaining the appearance of productivity.

This is the crux of Turkle's point about technology: We have become so attached to these devices that not only control our attention and behavior, but we also actively choose to depend on them for psychological comfort and social protection (Turkle 122). In other words, we have become so attached to our tethers that not only do the tethers hold us tightly, but we also hold the tethers tightly as well.

Using smartphones as protective shields can extend to more threatening situations. In another one of my observations, I noticed that there was a woman in a subway station, and a man approached her asking for money. As I watched the interaction unfold, I could see his extended hand and hear his repeated requests for "spare change" and mentions of his homelessness. She started quickly walking away while looking at her phone, keeping her eyes fixed on the screen rather than looking at him, while moving herself towards the station's main area, where more people were present. What I found really interesting was that the woman was on her phone the whole time, staring at it even though, I thought, the more probable pressing matter was the person behind her. I suppose there was the chance that staring at the man could have antagonized him, but staring at your phone, even superficially by not paying attention to the content on it, still heavily limits a person's ability to react should things escalate.

It's impossible to know if the woman was staring at her phone to avoid the trauma that might come with being followed. But if she were, there is some grounding in research. She may have been experiencing what researchers like Dr. Denise M. Sloan, associate director at the National Center for PTSD, calls "peritraumatic dissociation", a phenomenon characterized by emotional numbness and altered perception during stressful events (Swaim 5). A defense mechanism, peritraumatic dissociation allows the mind to protect itself by creating a mental escape when physical escape isn't possible, as fewer mental resources are dedicated to processing how scary or painful a situation feels (Swaim 5). In this case, the smartphone functions as a social shield, providing a visual barrier and a reason not to engage. One can go as far as to say it's an escape portal from an uncomfortable reality. In such a case, a person's behavior could demonstrate Turkle's concept of the "tethered self" in an extreme context, where being mentally elsewhere became part of a survival strategy rather than merely social avoidance. The dual existence of these two worlds, as Turkle frames them, could plays an interesting role here: while a person's body remains vulnerable in a subway station, their attention is elsewhere, away from the threat. Research by Dr. John Hunter, assistant professor of psychology at Chapman University, finds that smartphones can act as a "digital security blanket" that buffers against psychological stress (Hunter et al. 346). Their mere presence can decrease stress levels in people, as the study showed that people without access to smartphones had significantly increased levels of stress (Hunter et al. 349). It's a protective function that was never explicitly designed into smartphones, yet it seems to have become a common use in public spaces.

While phones shield us from immediate discomfort, they may ironically also amplify our broader anxieties about urban danger. These devices are sources for the constant stream of crime alerts, push notifications, and security footage that make public spaces feel perpetually unsafe (Riddell 34). If phones can soothe discomfort, they just as readily stoke it. In the moment, a vibrating phone offers a reassuring ritual: glancing down lets us escape awkward eye contact, confirm a train's ETA, or signal to friends that we're still alive in the tunnel dead zone. Yet the very streams that calm us also keep our anxiety circuits primed. 24-hour push notifications bombard New Yorkers with every robbery, shove, and scuffle, however rare. Each red banner lights up the brain's triggers the same stress response we'd feel if the incident were unfolding a few feet away (Intravia). Doom-scrolling, a recent trend defined by people spending excessive time scrolling through content made to make them feel sad, anxious, or angry, further reinforces this loop (Doomscroll): every swipe delivers fresh jolts of negative stimulus and a hit of dopamine for "staying informed," so users oscillate between dread and reward (Dolgoff). The result is what experts like Dr. Timothy J. Legg, adjunct professor in the Pepperdine Graduate School of Education and Psychology, called hyper-vigilant fatigue: the body's fight-or-flight switch remains half-pressed, so even the ordinary clang of closing doors feels ominous (Gotter). In urban environments like New York City, these algorithmic notifications inadvertently create chronically stressed commuters who constantly perceive danger where little exists. While it is important for commuters to be aware of real, tangible threats nearby, current smartphone designs lack a balance between providing adequate safety information and psychological well-being. In a city that never sleeps, the phone that never rests ensures anxiety never fully powers down.

The disconnect between how smartphones were designed and how they're actually used raises important questions for technology designers. When Jobs unveiled the iPhone, he emphasized productivity, entertainment, and communication, not social avoidance or psychological self-protection. Yet my observations suggest these unintended functions fulfill genuine human needs in an increasingly crowded, stimulating world. The difference between Job's intentions for the iPhone and what we currently use them for is a great example of what Langdon Winner, a professor at Rensselaer Polytechnic Institute, described as "technological somnambulism" – a societal tendency for us to sleepwalk through technological changes that fundamentally reshape our societal activities. Winner was writing in 1973, but clearly he was a man ahead of his time, as these thoughts apply to how the smartphone, one of the most fundamental technologies of the 21st century, has changed society. We adopted smartphones without fully examining their side effects, and only later did we truly realize the true side effects they have in our world (Winner 53). How might technology be designed differently if engineers acknowledged these actual usage patterns? What ethical responsibility do designers have when creating tools that so profoundly shape social behavior?

Technology designers must recognize that their creations don't simply serve stated functions but actively reshape social norms and human behavior, now bearing a significant ethical responsibility. As we design future technologies, acknowledging how these tensions are developed might help create tools that better align with genuine human needs rather than inadvertently amplifying our social anxieties.`
},
{ 
    version: "Draft 4", 
    text: `Ping! Panic! Repeat!

Picture a late-night subway ride on the F subway line: fluorescent lights flicker overhead, a half-empty car rattles through the tunnel, and every few seconds somebody's phone buzzes. "Armed robbery—Upper East Side," flashes one push notification. "Man shoved onto tracks in Midtown," warns another. A teenager beside you scrolls an endless reel of grainy security-camera clips, often with some unsuspecting victim about to be assaulted. A middle-aged commuter checks the Citizen app, its red map pins pulsing like fresh wounds across the city grid. Even the PA system crackles with an "if you see something, say something" reminder. Surrounded by screens and alerts, the train car feels poised for disaster, and instinctively, you tighten your grip on the handrail, eyes darting toward every stranger who wanders too close.

Yet that sense of danger may be a digital mirage. According to the NYPD's first-quarter 2025 report, subway crime is down double digits, with zero murders—the safest start to a year in at least seven years and among the lowest violent-crime tallies ever recorded on the system (NYPD). Maybe what can make an ordinary ride feel dangerous is not an epidemic of violence but the smartphones in our pocket. I spent three weeks in February of 2025 riding numerous subway lines and bus routes, documenting episodes of public phone use. More broadly, I began to see that while smartphones were designed to connect us and keep us informed, they have evolved into sophisticated social tools that help manage our anxieties while navigating urban spaces.

The patterns I observed Steve Jobs, the founder of Apple, who envisioned his smartphone bringing people together. When Jobs unveiled his ideas for the first iPhone in 2007, Jobs spoke of seamless communication and instant connection (Pangambam). But that's not the way I saw smartphones being used on transit. There, I began to think of them as constructing what I call "social shields," digital barriers that allow users to avoid physical interactions in a socially acceptable way, the antithesis to Job's vision. By staring at a screen, users can avoid eye contact, deflect unwanted conversations, and, perhaps, create psychological distance from their immediate environment while maintaining the appearance of productivity.

My idea of a "social shield" emerged from what technology sociologist Sherry Turkle coined the "tethered self" in her essay "Always-On/Always-On-You: The Tethered Self." Writing in 2008, just one year after the release of the iPhone, Turkle predicted with remarkable precision about how these devices could reshape social life. She described how smartphones were creating a state of society where we are "always-on/always-on-you," a reference to how smartphones are always readily available (Turkle 121). Turkle, a professor of social studies of science and technology at Massachusetts Institute of Technology, describes how our "tethered self" can maintain a constant psychological readiness for the connections that matter to us digitally (121). The smartphone creates a "liminal space between the physical real and its digital lives on multiple screens," Turkle writes (122). We are never fully here, yet never fully elsewhere either.

Based on my observations, many people embrace this "tethered self," actively choosing to turn to their digital worlds during moments of social discomfort, regardless of whether they have actual messages or notifications to address. Riding the M103 down Third Avenue, I watched two friends chat easily. They had a nice, long conversation, talking about their daily lives, with neither of them holding a smartphone at all. After a while, it seemed like one of the friends had reached his stop. He said goodbye to his friend and left the bus, leaving the other friend to ride alone. The moment the remaining rider was alone, he cast a cautious glance around, made brief eye contact with me, and fled into his phone. When I made eye contact, I also felt a similar urge, pulling out my phone to start playing video games. Maybe when one person withdraws into their device, it signals to others that the digital escape is both accepted and expected. In my mind, eye contact with a stranger was uncomfortable, and I felt a need to intentionally distract myself with a phone to try to relieve myself of the awkward situation. Maybe the stranger felt the same way.

The tether can act as more than a quick way for users to create psychological buffers. On the subway, the smartphones are also repurposed as a means to actively avoid eye contact. I could be doing absolutely nothing on my phone, just staring at the weather for the hundredth time, yet it creates the sense of safety that I will not accidentally stare right into someone's eyes, possibly creating an unsettling and tense situation. There's a cultural backing behind my behavior; there are plenty of folktales on the New York City subway about how making momentary eye contact with a stranger resulted in an altercation. Ironically, devices engineered to enhance connection can also become tools that dissuade it just as easily. The smartphone's design makes it an ideal shield—its screen demands attention and signals busyness to others, creating a socially acceptable way to opt out of physical presence while maintaining the appearance of productivity.

This is the crux of Turkle's point about technology: We have become so attached to these devices that not only control our attention and behavior, but we also actively choose to depend on them for psychological comfort and social protection (Turkle 122). In other words, we have become so attached to our tethers that not only do the tethers hold us tightly, but we also hold the tethers tightly as well.

Using smartphones as protective shields can extend to more threatening situations. In another one of my observations, I noticed that there was a woman in a subway station, and a man approached her asking for money. As I watched the interaction unfold, I could see his extended hand and hear his repeated requests for "spare change" and mentions of his homelessness. She started quickly walking away while looking at her phone, keeping her eyes fixed on the screen rather than looking at him, while moving herself towards the station's main area, where more people were present. What I found really interesting was that the woman was on her phone the whole time, staring at it even though, I thought, the more probable pressing matter was the person behind her. I suppose there was the chance that staring at the man could have antagonized him, but staring at your phone, even superficially by not paying attention to the content on it, still heavily limits a person's ability to react should things escalate.

The dual existence of these two worlds, as Turkle frames them, could play an interesting role here: while a person's body remains vulnerable in a subway station, their attention is elsewhere, away from the threat. Research by Dr. John Hunter, assistant professor of psychology at Chapman University, finds that smartphones can act as a "digital security blanket" that buffers against psychological stress (Hunter et al. 346). Their mere presence can decrease stress levels in people, as the study showed that people without access to smartphones had significantly increased levels of stress (Hunter et al. 349). It's a protective function that was never explicitly designed into smartphones, yet it seems to have become a common use in public spaces.

While phones shield us from immediate discomfort, they may ironically also amplify our broader anxieties about urban danger. These devices are sources for the constant stream of crime alerts, push notifications, and security footage that make public spaces feel perpetually unsafe (Riddell 34). If phones can soothe discomfort, they just as readily stoke it. In the moment, a vibrating phone offers a reassuring ritual: glancing down lets us escape awkward eye contact, confirm a train's ETA, or signal to friends that we're still alive in the tunnel dead zone. Yet the very streams that calm us also keep our anxiety circuits primed. 24-hour push notifications bombard New Yorkers with every robbery, shove, and scuffle, however rare. Doom-scrolling, a recent trend defined by people spending excessive time scrolling through content made to make them feel sad, anxious, or angry, further reinforces this loop (Doomscroll): every swipe delivers fresh jolts of negative stimulus and a hit of dopamine for "staying informed," so users oscillate between dread and reward (Dolgoff). The result is what experts like Dr. Timothy J. Legg, adjunct professor in the Pepperdine Graduate School of Education and Psychology, called hyper-vigilant fatigue: the body's fight-or-flight switch remains half-pressed, so even the ordinary clang of closing doors feels ominous (Gotter). In urban environments like New York City, these algorithmic notifications inadvertently create chronically stressed commuters who constantly perceive danger where little exists. While it is important for commuters to be aware of real, tangible threats nearby, current smartphone designs lack a balance between providing adequate safety information and psychological well-being. In a city that never sleeps, the phone that never rests ensures anxiety never fully powers down.

The disconnect between how smartphones were designed and how they're actually used raises important questions for technology designers. When Jobs unveiled the iPhone, he emphasized productivity, entertainment, and communication, not social avoidance or psychological self-protection. Yet my observations suggest these unintended functions fulfill genuine human needs in an increasingly crowded, stimulating world. The difference between Job's intentions for the iPhone and what we currently use them for is a great example of what Langdon Winner, a professor at Rensselaer Polytechnic Institute, described as "technological somnambulism" – a societal tendency for us to sleepwalk through technological changes that fundamentally reshape our societal activities. Winner was writing in 1973, but clearly he was a man ahead of his time, as these thoughts apply to how the smartphone, one of the most fundamental technologies of the 21st century, has changed society. We adopted smartphones without fully examining their side effects, and only later did we truly realize the true side effects they have in our world (Winner 53). My observations suggest these unintended functions fulfill genuine human needs in an increasingly crowded, stimulating world. The gap between smartphones' designed purpose and actual use reflects our conflicting desires: we crave both connection and isolation, productivity and distraction, social engagement and personal retreat. How might technology be designed differently if engineers acknowledged these actual usage patterns? What ethical responsibility do designers have when creating tools that so profoundly shape social behavior?

Technology designers must recognize that their creations don't simply serve stated functions but actively reshape social norms and human behavior, now bearing a significant ethical responsibility. As we design future technologies, acknowledging how these tensions are developed might help create tools that better align with genuine human needs rather than inadvertently amplifying our social anxieties.`
},

{ 
    version: "Final Draft", 
    text: `Ping! Panic! Repeat!

Back in February, there was a stabbing near High Street at Tandon, but I didn't realize anything had happened until I got the alert on my Citizen app hours later, and I felt retroactively scared. Without it, I would never have known anything dangerous had occurred near me that day. When I first downloaded the Citizen app back in November, I'd already been riding the subways for two or three months without incident. On the subway, I never noticed anything dangerous around me, but once I had the app, I could see a massive map with countless different crimes happening across the city, curating all of these incidents for me. I was certainly a lot more worried after downloading the app, even though I was never actually a victim of crime. Was it better that I didn't know before? This experience with Citizen made me wonder how much our phones might be shaping our perception of urban danger, and what all these alerts and notifications were doing to me.

That realization sparked broader research questions about cellphone use that I brought to an ethnographic study I conducted last Spring, as a computer science major at Tandon. Coming from California, I was struck by how much people used their phones on New York subways. For millions of New Yorkers, the subway isn't just transportation—it's a lifeline carrying people to work, school, and social gatherings, and almost everyone I saw traveled peering at their cellphones. This ubiquitous phone usage made me curious about what was driving this behavior: Were phones simply entertainment, or were they serving a deeper psychological function in navigating urban society? I spent three weeks in February 2025 riding three subway lines and two bus routes within the Metropolitan Transportation Authority (MTA), documenting over ten hours of public phone use. I began to see that while smartphones were designed to connect us and keep us informed, they have evolved into sophisticated social tools that help manage our anxieties while navigating urban spaces. But in some cases, they may spark those anxieties as well.

The patterns I observed reveal how we've collectively chosen to use smartphones in ways its creators apparently advertised. When Steve Jobs introduced the iPhone in a speech in 2007, he described it as a revolutionary combination of three devices: "a widescreen iPod with touch controls," "a revolutionary mobile phone," and "a breakthrough Internet communications device." He focused on its groundbreaking capabilities, creating phones that had "the Internet in your pocket" (Jobs qtd. in Pangambam). Jobs was positioning the iPhone as a productivity and connectivity tool, designed to make communication, web browsing, and media consumption more efficient and seamless. His presentation was about what the technology could do, but not about what we would use the technology to do. Riding the subway in 2025, I witnessed users actively adapting the cellphone to avoid, rather than make, connections.

Riding the M103 down Third Avenue, I watched two friends chat easily. They had a nice, long conversation, talking about their daily lives, with neither of them holding a smartphone at all. After a while, it seemed like one of the friends had reached his stop. He said goodbye to his friend and left the bus, leaving the other friend to ride alone. The moment the remaining rider was alone, he cast a cautious glance around, made brief eye contact with me, and fled into his phone. When I made eye contact, I also felt a similar urge, pulling out my phone to start playing video games. Maybe when one person withdraws into their device, it signals to others that the digital escape is both accepted and expected. In my mind, eye contact with a stranger was uncomfortable, and I felt a need to intentionally distract myself with a phone to try to relieve myself of the awkward situation. Maybe the stranger felt the same way. Our phones had become what I began to call a 'social shield.'

My idea of a 'social shield' emerged from the "tethered self," a term technology sociologist Sherry Turkle coined in her essay "Always-On/Always-On-You: The Tethered Self". Writing in 2008, just one year after the release of the iPhone, Turkle predicted with remarkable precision about how these devices could reshape social life. She described how smartphones were creating a state of society where we are "always-on/always-on-you," a reference to how smartphones are always readily available (Turkle 121). Turkle, a professor of the social studies of science and technology at Massachusetts Institute of Technology, describes how our "tethered self" can maintain a constant psychological readiness for the connections that matter to us digitally (121). The smartphone creates a "liminal space between the physical real and its digital lives on multiple screens," Turkle writes paraphrasing Dr. Victor Turner, a professor of anthology at the University of Virginia (122). We are never fully here, yet never fully elsewhere either.

Based on my observations on the M103 bus and elsewhere, many people embrace this "tethered self," actively choosing to turn to their digital worlds during moments of social discomfort, regardless of whether they have actual messages or notifications to address. The tether can act as more than a quick way for users to create psychological buffers. On the subway, the smartphones are also repurposed as a means to actively avoid eye contact. I could be doing absolutely nothing on my phone, just staring at the weather for the hundredth time, yet it created the sense of safety that I would not accidentally stare right into someone's eyes, possibly creating an unsettling and tense situation. There's a cultural backing behind my behavior. Moving to New York City, I heard plenty of folktales on the New York City subway about how making momentary eye contact with a stranger resulted in an altercation. Jeremy McCarthy, a New Yorker with a Masters in Applied Psychology, has reflected on this issue, considering how the big city environment of New York City forces us to be more risk-averse, and that making eye contact creates risk and vulnerability; to do so would require us to feel confident and safe with the strangers around us (McCarthy). However, in a city with eight million different personalities, such a premise is impossible to guarantee. As such, a 2023 New York Times article explicitly listed "no eye contact" as one of the fundamental "unwritten rules" of the subway (Ley). So, by allowing us to avoid eye contact, smartphones engineered to enhance connection can also become tools that dissuade it just as easily, creating a socially acceptable way to opt out of physical presence while maintaining the appearance of productivity.

This is the crux of Turkle's point about technology: We have become so attached to these devices that not only control our attention and behavior, but we also actively choose to depend on them for psychological comfort and social protection (Turkle 122). In other words, we have become so attached to our tethers that not only do they hold us tightly, but we also hold the tethers tightly as well.

Using smartphones as protective shields can extend to more threatening situations. In another one of my observations, I noticed that there was a woman in a subway station, and a man approached her asking for money. As I watched the interaction unfold, I could see his extended hand and hear his repeated requests for "spare change" and mentions of his homelessness. She started quickly walking away while looking at her phone, keeping her eyes fixed on the screen rather than looking at him, while moving herself towards the station's main area, where more people were present. What I found really interesting was that the woman was on her phone the whole time, staring at it the whole time. As I saw it, the smartphone was functioning as a social shield, providing a visual barrier and a reason for her not to engage. While the woman physically remained in the subway station, it seemed like her attention had wandered elsewhere. Did the woman's smartphone allow her to psychologically escape a potentially threatening situation by tethering her mind to a safer digital space? I wondered if Turkle's concept of the "tethered self" could extend to an extreme context, where a person being mentally elsewhere could become part of a survival strategy rather than merely social avoidance.

While phones shield us from immediate discomfort, they may ironically also amplify our broader anxieties about urban danger. Researcher Alice Riddell conducted an eight-month ethnographic study in Brooklyn neighborhoods to investigate how Citizen's crime-tracking app was affecting residents' sense of safety and community. Using participant observation and interviews with more than seventy people, Riddell found that while Citizen can serve as a tool for community building, it simultaneously creates fear and mistrust. She wrote, "Apps with maps are powerful, making users feel small yet significant, creating reference points of relation with the self always at the centre. Citizen creates an overwhelming map of your area that gives the impression that your neighbourhood is constantly under siege and therefore a space to be mistrustful of" (Riddell 37). While it is important for commuters to be aware of real, tangible threats nearby, I believe that current smartphone apps like Citizen lack a balance between providing adequate safety information as well as psychological well-being. In a city that never sleeps, the phone that never rests may ensure anxiety that never fully powers down.

The disconnect between how smartphones were designed and how they're actually used raises important questions for technology designers. When Jobs unveiled the iPhone, he emphasized productivity, entertainment, and communication, not social avoidance nor psychological self-protection. The difference between Job's stated intentions for the iPhone and what we currently use them for is a great example of what Langdon Winner, a professor at Rensselaer Polytechnic Institute, described as "technological somnambulism"—a societal tendency for us to sleepwalk through technological changes that fundamentally reshape our societal activities. Winner was writing in 1973, reflecting on how cars and televisions had radically changed societal functions, but clearly, he was a man ahead of his time. His thoughts clearly apply to how the smartphone, one of the most fundamental technologies of the twenty-first century, has also changed society. "Only later does the broader significance of the choice become clear, typically as a series of surprising 'side effects' or 'secondary consequences'" (Winner 53). The gap between smartphones' designed purpose and actual use reflects our conflicting desires: we crave both connection and isolation, productivity and distraction, social engagement and personal retreat. We use them for both, and in doing so, they shape our behaviors.

Yet it would be far too simplistic and deterministic to say that people just passively let technology change them. As Winner puts it, this idea "does little justice to the genuine choices that arise, in both principle and practice, in the course of technical and social transformation" (Winner 53). The key insight Winner identifies is that we, as a society, must recognize our active role in shaping our society through technology. "Throughout their lives people come together to renew the fabric of relationships, transactions, and meanings that sustain their common existence" (Winner 59). Technology is a tool we use to create this social fabric, but we remain the weavers. This perspective leads Winner to pose the crucial question: "What kind of world are we making?" (Winner 59).

For those of us who find ourselves tethered to our devices on daily commutes, the answer is that we need to realize we have more agency than we think we do. The simple advice to "look up" feels inadequate given how deeply these patterns run. It's hard for me to remember the last time I left my dorm without my phone. But recognizing that we may be using technology to manage urban anxiety, rather than being controlled by our phones, opens possibilities for more intentional engagement. Understanding our phones as 'social shields' rather than inevitable dependencies can help us make more conscious choices about when and how we engage with our devices. This doesn't mean forcing ourselves into uncomfortable eye contact with strangers or abandoning the psychological comfort our phones provide. Instead, it means becoming more aware of the trade-offs we're making. My experience with the Citizen app taught me that sometimes ignorance can be a form of peace, but for others, a conscious choice to consume information about their surroundings may also be a form of peace. The goal is not to decrease or eliminate smartphone usage, but to use them more deliberately.

For technology designers, these questions carry greater weight. Designers must recognize that our creations don't simply serve stated functions, but also actively reshape social norms and human behavior, bearing significant ethical responsibility. Designers must not simply seek to avoid harm but to actively consider the social and psychological conditions being created, asking questions before widespread adoption rather than discovering problematic effects afterward. Winner is clear about this obligation, writing: "Much more than we have acknowledged in the past, we must admit our responsibility for what we are making" (Winner 59). Importantly, Winner is speaking to society as a whole, as our own interactions with technology also fuel these changes. At the end of the day, we all bear some responsibility for examining how new technologies impact our collective lives. As we move forward with technological innovation, acknowledging these tensions might help create tools that better align with genuine human needs rather than inadvertently amplifying our social anxieties.`
}
                ]
            },


          essay2: {
    title: "Simulated Systems and the Limits of Intuitive Learning",
    author: "Srinivas Harish",
    description: "Examining how simulations shape our understanding of complex systems",
    drafts: [
        { 
            version: "Draft 1", 
            text: `However, this reduction in extraneous load comes at a cost. Sweller posits that while managing extraneous load is essential, there is a risk of oversimplification. By reducing unnecessary cognitive strain, KSP may strip away the intrinsic complexity of space travel and compromise germane cognitive load. As such, the simplified interface could reduce deep learning and schema development (Sweller, 2011) by reducing the opportunities for the mental struggle necessary for true scientific understanding. The player does not have to calculate rocket trajectories or orbital mechanics manually and the game alone might not help in developing robust mental schemas needed for independent problem-solving, which involves expending mental effort in reorganizing and internalizing information. This also ties into Sweller's expertise reversal effect, where techniques that help novices may become counterproductive as learners gain more experience. As players grow more proficient at KSP, they may begin to rely too heavily on the game's interface and structure, potentially hindering their ability to tackle real-world, unstructured problems. Perhaps then, this suggests that instructional techniques that were once helpful can become detrimental. For novices, KSP's structured guidance is invaluable, but for experts, the same guidance may become redundant in more complex learning.

Interestingly, however, while KSP's interface facilitates initial learning, it also sparked my curiosity to dive deeper into the science behind space exploration. This led me to calculate interplanetary Hohmann transfer trajectories manually and write a paper on the topic. The game acted as an inspiration, providing a stepping stone from simple, guided experimentation to more advanced, independent scientific inquiry. This suggests that while KSP reduces the cognitive load in the early stages, it can also catalyze deeper learning, where the player can tackle more complex, real-world calculations outside the game's simplified and structured framework.

While this structured environment of KSP is ideal for teaching fundamental principles, it starkly contrasts with the unpredictability and risk inherent to real-world scientific exploration and discovery. A pre-configured structure lacks the messiness that Ann-Sophie Barwich identifies as crucial for scientific discovery in her essay, "The Value of Failure in Science" Barwich argues that failure is not merely an impediment but a driving force for progress, stating, "Science fails... at a high rate and with regularity, [it is not] successful despite such prevalent failures... it is successful because of them." (Barwich, 2019) Barwich values cognitive load and failure as mechanisms for discovery, while Sweller would argue that too much cognitive load can hinder learning. This perspective highlights a key limitation of KSP: its deterministic framework undermines the role of serendipity, anomalies, and long-term consequences in fostering paradigm shifts. Barwich's analysis of the flawed grandmother cell theory illustrates the value of such chaos—errors and unanticipated results often provoke questions and reshape understanding. In real-world science, serendipity and ambiguity often force researchers to explore paths they hadn't anticipated. For example, the discovery of penicillin resulted from a serendipitous failure (Ban, 2006), and the theory of cosmic microwave background radiation emerged from unintentional noise in radio antenna data (Oliver, 2020). These paradigm shifts represent the very essence of revolutionary science and were an accidental result of unpredictable failure.

These discoveries show that considering the type of failure matters as much as the failure itself--catastrophic failures often halt progress entirely, while inspirational failures provoke further questions, and serendipitous failures lead to unexpected breakthroughs. Thomas Edison's thousands (Goodman, 2013) of unsuccessful attempts at designing a light bulb built resilience, and ethical implications underscore the fact that science does not exist in a vacuum: catastrophic failures can lead to societal harm, environmental destruction, or controversial technological applications, as seen with disasters like the Challenger (NASA, 2024) explosion. Yet, in KSP, progress is neatly packaged into a closed-loop feedback system where players rebuild and retry within the bounds of predetermined solutions, where failure is not just acceptable, but entertaining. As such, no deeper questioning of assumptions is required as no anomalies would ever force a reconsideration of the game's underlying logic. Thus, the absence of epistemological upheaval renders the game a simplified approximation of scientific progress, devoid of the intellectual chaos and cognitive complexity that fuels genuine breakthroughs. Barwich might contend this is an exercise in following rules encouraging fixed patterns of thought rather than exploring the unknown with adaptive expertise, a limitation that Sweller's CLT overlooks in its quest for simplified learning. Sweller, however, would likely respond that the struggle inherent to Barwich's model, while beneficial for true discovery, could overwhelm learners at a foundational level, pushing them toward frustration rather than motivation. Barwich implicitly suggests that the cognitive strain imposed by failure—what might be classified as intrinsic or even germane load—plays a critical role in cultivating higher-order thinking and epistemic innovation. However, KSP and similar simulations cannot fully replicate the raw epistemology of science, as they remain confined within pre-defined structures, incapable of capturing the unpredictable and ethically complex nature of genuine scientific discovery.`
        },
        { 
            version: "Draft 2", 
            text: `However, this reduction in extraneous load comes at a cost. Sweller emphasizes that instructional design must "reduce extraneous cognitive load without altering [its] intrinsic nature" (Sweller, 2011). In KSP, there is a risk of oversimplification. By removing the need to calculate trajectories or manipulate equations, it strips some of the inherent complexity of space travel. This could compromise germane load by limiting the mental struggle needed to build deep, transferable schemas necessary for scientific discovery. This also ties into Sweller's "expertise reversal effect" (Sweller, 2011), where techniques that help novices may become counterproductive as learners gain more experience. As players grow more proficient at KSP, they may begin to rely too heavily on the simulation's interface and structure, potentially hindering their ability to tackle real-world, unstructured problems. Perhaps then, this suggests that instructional techniques that were once helpful can become detrimental. For novices, KSP's structured guidance is invaluable, but for experts, the same guidance may become a hindrance to more complex learning.

But even beyond the risks of over-structuring, there's a deeper complication: what KSP defines as "failure" isn't failure in a practical sense. It's intuitive failure that's bounded and easily corrected—more of a design loop than an epistemic disruption. This stands in contrast to the messy, high-stakes failure that drives scientific discovery, as German cognitive scientist Ann-Sophie Barwich argues in her essay, "The Value of Failure in Science." Barwich says failure is not merely an impediment but a driving force for progress, stating, "Science fails... at a high rate and with regularity, [it is not] successful despite such prevalent failures... it is successful because of them" (Barwich, 2019). If we take failure as a mechanism that increases cognitive load, then Sweller's warning that excessive cognitive strain can overwhelm learners and hinder schema formation stands in tension with Barwich's view that failure, and thus the cognitive strain from it, is epistemically generative.

However, Barwich's epistemic view of failure highlights a key limitation of KSP: its deterministic framework undermines the role of serendipity, anomalies, and long-term consequences in fostering paradigm shifts. In her critique of the grandmother cell theory, Barwich shows how scientific progress emerged only after anomalies forced a rejection of this overly simplistic view. The collapse of the theory led to a deeper understanding of distributed neural processing, illustrating how failure can provoke conceptual change rather than just iterative refinement. In real-world science, serendipity and ambiguity often force researchers to explore paths they hadn't anticipated. For example, the discovery of penicillin resulted from a serendipitous failure (Ban, 2006), and the theory of cosmic microwave background radiation emerged from unintentional noise in radio antenna data (Oliver, 2020). These paradigm shifts represent the very essence of revolutionary science and were an accidental result of unpredictable failure. Some failures, I'd argue, are more epistemically productive than others: catastrophic failures may halt progress entirely, while inspirational failures provoke new questions, and serendipitous failures yield unanticipated breakthroughs. Edison's thousands (Goodman, 2013) of unsuccessful attempts at designing a light bulb built resilience, and ethical implications underscore the fact that science does not exist in a vacuum: catastrophic failures can lead to societal harm, environmental destruction, or controversial technological applications, as seen with disasters like the Challenger (NASA, 2024) explosion.

Yet such epistemically rich failures require conditions that KSP does not provide. In KSP, failure is intuitive, recoverable, and ultimately entertaining—a design feature rather than a disruption. Progress is neatly packaged into a closed-loop feedback system where players rebuild and retry within the bounds of predetermined solutions. As such, no deeper questioning of assumptions is required, since no anomalies ever force a reconsideration of the game's underlying logic. The absence of epistemological upheaval renders KSP a simplified approximation of scientific progress, one devoid of the intellectual chaos, conceptual instability, and open-ended failure that often fuels scientific discovery. Barwich emphasizes that failure is not merely a pedagogical inconvenience but a necessary condition for challenging and refining scientific frameworks as they lead to "active engagement with the limits of understanding" (Barwich, 2019). This perspective helps illuminate the limits of KSP as a learning tool: while the simulation enables iterative trial and error, it does so within a stable, rule-bound environment. There are no paradigm-breaking anomalies, only errors that can be corrected by better optimization within a closed system. As such, the type of failure KSP enables does not compel players to rethink assumptions or confront epistemological uncertainty. Barwich's insight casts KSP as an exercise in following rules rather than exploring the unknown, and reveals how its structured feedback system encourages fixed patterns of thought rather than adaptive expertise. From a Swellerian perspective, this would be seen as a feature, not a flaw—one that reduces extraneous load and supports efficient schema formation. However, Barwich's framework reveals that this very efficiency might come at the cost of scientific creativity.`
        },
        { 
            version: "Final Draft", 
            text: `KSP's oversimplification may also come at a cost to STEM students later in their careers. In his essay, Sweller introduced the "expertise-reversal effect," which occurs when learning scaffolds that support novices start to hinder more advanced learners as those scaffolds themselves become an extra load (Sweller 131). In KSP, every maneuver node, thrust readout, and on-screen trajectory cue serves as that kind of scaffold. The longer a player uses those aids, the more the aids become baked into the problem-solving routine, resulting in a kind of cognitive overadjustment to the simulation. When the real world no longer shows a blue maneuver node or a perfect delta-v readout, what began for the player as a learning aid can become a surprisingly hard-to-escape cage. The player receives inputs, updates internal schemas through feedback, and iteratively builds a model of the world. Over time, the game's interface and cues act like learned priors, scaffolding intuitive responses that feel like mastery, but may not generalize beyond the simulation. In that sense, what KSP cultivates is not so much deep understanding, but a self-model conditioned on success within a closed system. A constrained self-model—a learner's internal representation of what they can do and how the system works—becomes brittle: optimized for success within a closed loop, but unprepared for the noise of real-world science.

Yet oversimplification is only half the problem. As a simulation, KSP teaches you to succeed in its rule space but not necessarily to question the assumptions that world is built on. In KSP, failure is a bounded design loop, but true scientific progress often stems from failures that break the framework itself. In her essay "The Value of Failure in Science," cognitive scientist Ann-Sophie Barwich introduces and analyzes case studies in which scientists' failures led to deeper learning, including the discarded grandmother-cell theory. This theory proposed that single neurons could encode specific complex concepts, including recognizing one's grandmother. The theory gained traction before evidence was found suggesting that complex concepts are distributed across neural networks, leading researchers to adopt a new, distributed model of neural representation (Barwich 3). Barwich writes, "Science fails. It seems to fail at a high rate and with regularity. . . . One may wonder why science is so successful despite such prevalent failures. The alternative is to suggest that it is successful because of them" (Barwich 1).

Barwich's arguments about failure being integral to scientific discovery align with another core feature of scientific research: the importance of uncertainty and happy accidents. Paradigm-level disruption often begins with an unexpected result. Penicillin emerged when Alexander Fleming noticed that a mold contaminating his Petri dishes killed nearby bacteria, and what looked like ruined cultures revealed an antibiotic (Ban 337-338). The detection of the cosmic microwave background followed a similar pattern: Arno Penzias and Robert Wilson tried to eliminate a persistent background hiss in their radio antenna, only to discover the remnant radiation of the Big Bang (Oliver). Neither event was an error to be 'fixed.' Each anomaly called the prevailing explanatory framework into question and compelled scientists to build a deeper one—or a new framework altogether.

Barwich's view of failure as a kind of "epistemic" disturbance—what she calls "active engagement with the limits of understanding" (Barwich 2)—is precisely what a deterministic simulation like KSP cannot supply. In KSP, failure is intuitive, recoverable, and ultimately entertaining—a design feature rather than a disruption. Progress is neatly packaged into a closed-loop feedback system where players rebuild and retry within the bounds of predetermined solutions. There are no paradigm-breaking anomalies that force a reconsideration of the game's underlying logic, only errors that can be corrected by better optimization within a closed system. As such, the type of failure KSP enables does not compel players to rethink assumptions or confront epistemological uncertainty. Barwich's insight casts KSP as an exercise in following rules rather than exploring the unknown, and reveals how its structured feedback system encourages fixed patterns of thought rather than adaptive expertise. From a Swellerian perspective, KSP's avoidance of real failure might be seen as a pedagogical strength at an early stage of learning by removing epistemic friction and reducing extraneous load and making a difficult subject more approachable. But Barwich's view reframes this very efficiency as a limitation. By insulating players from paradigm-level disruptions, KSP risks flattening the intrinsic complexity of spaceflight into something that feels merely iterative. Without anomalies that violate the rules, learners practice refinement within a fixed system—but never confront the kind of disorientation that sparks new frameworks and deeper insight.`
        }
    ]
}
};
       
        
        function createPanels(essay) {
            const slider = document.getElementById('comparisonSlider');
            slider.innerHTML = ''; // Clear existing panels
            
            const panels = [];
            
            // Create panels: Draft 1, Diff 1→2, Draft 2, Diff 2→3, Draft 3, etc.
            for (let i = 0; i < essay.drafts.length; i++) {
                // Add draft panel
                const draftPanel = document.createElement('div');
                draftPanel.className = 'panel';
                const formattedText = formatText(essay.drafts[i].text);
                draftPanel.innerHTML = `
                    <h3>${essay.drafts[i].version}</h3>
                    <div class="panel-content">${formattedText}</div>
                `;
                slider.appendChild(draftPanel);
                panels.push({ type: 'draft', index: i });
                
                if (i < essay.drafts.length - 1) {
                    const diffPanel = document.createElement('div');
                    diffPanel.className = 'panel diff-panel';
                    const formattedText1 = formatText(essay.drafts[i].text);
                    const formattedText2 = formatText(essay.drafts[i + 1].text);
                    const diffContent = generateAdvancedDiff(formattedText1, formattedText2);
                    diffPanel.innerHTML = `
                        <h3>Changes: ${essay.drafts[i].version} → ${essay.drafts[i + 1].version}</h3>
                       <div class="diff-legend">
                            <span class="legend-item"><span class="deletion word-level">Deleted</span></span>
                            <span class="legend-item"><span class="addition word-level">Added</span></span>
                        </div>
                        <div class="panel-content">${diffContent}</div>
                    `;
                    slider.appendChild(diffPanel);
                    panels.push({ type: 'diff', fromIndex: i, toIndex: i + 1 });
                }
            }
            
            // At the end of createPanels function, before 'return panels;'
            // Enable annotations after a short delay to ensure DOM is ready
            setTimeout(() => {
                if (panels[0].type === 'diff') {
                    makeAnnotatable(
                        essay.title,
                        essay.drafts[panels[0].fromIndex].version,
                        essay.drafts[panels[0].toIndex].version
                    );
                }
            }, 100);


            return panels;
        }
        
        function loadExampleEssay(essayId) {
    // Show spinner
    document.getElementById('loadingSpinner').style.display = 'flex';
    
    const essay = exampleEssays[essayId];
    if (!essay || !essay.drafts) {
        document.getElementById('loadingSpinner').style.display = 'none';
        showError('Example essay not found.');
        return;
    }
            
            currentEssay = essay;
            
            // Clear any previous errors
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) errorMessage.style.display = 'none';
            
            // Hide upload section
            const uploadSection = document.querySelector('.upload-section');
            if (uploadSection) uploadSection.classList.add('hidden');
            
            // Create all panels
            const panelInfo = createPanels(essay);
            totalPanels = panelInfo.length;
            currentPosition = 0;
            
            // Display results
            const comparisonResults = document.getElementById('comparisonResults');
            if (comparisonResults) {
                comparisonResults.style.display = 'block';
                updateSliderPosition();
                updateNavigationInfo(panelInfo);
            }
            
            // Add event listener for new comparison button
            setupNewComparisonButton();

            // Hide spinner
            document.getElementById('loadingSpinner').style.display = 'none';

              // Save state
        saveState();
        }
        
        function updateNavigationInfo(panelInfo) {
            const navInfo = document.getElementById('navigationInfo');
            if (navInfo && panelInfo[currentPosition]) {
                const panel = panelInfo[currentPosition];
                if (panel.type === 'draft') {
                    navInfo.textContent = currentEssay.drafts[panel.index].version;
                } else if (panel.type === 'diff') {
                    navInfo.textContent = `Changes: ${currentEssay.drafts[panel.fromIndex].version} → ${currentEssay.drafts[panel.toIndex].version}`;
                }
            }
        }

        function setupNewComparisonButton() {
    const headerNewComparisonBtn = document.getElementById('headerNewComparisonBtn');
    if (headerNewComparisonBtn) {
        // Show the button in header
        headerNewComparisonBtn.classList.remove('hidden');
        
        // Remove any existing event listeners to avoid duplicates
        headerNewComparisonBtn.replaceWith(headerNewComparisonBtn.cloneNode(true));
        
        // Get the fresh button reference and add event listener
        const freshBtn = document.getElementById('headerNewComparisonBtn');
        freshBtn.addEventListener('click', function() {
            // Hide the button
            freshBtn.classList.add('hidden');
            
            // Show upload section
            const uploadSection = document.querySelector('.upload-section');
            if (uploadSection) uploadSection.classList.remove('hidden');
            
            // Hide comparison results
            const comparisonResults = document.getElementById('comparisonResults');
            if (comparisonResults) comparisonResults.style.display = 'none';
            
            // Clear uploaded files if any
            const file1Input = document.getElementById('file1');
            const file2Input = document.getElementById('file2');
            if (file1Input) file1Input.value = '';
            if (file2Input) file2Input.value = '';
            
            // Clear any uploaded files array
            if (typeof uploadedFiles !== 'undefined') {
                uploadedFiles = [];
            }
            
            // Reset any file lists
            const fileList = document.getElementById('fileList');
            const compareBtn = document.getElementById('compareFiles');
            if (fileList) fileList.style.display = 'none';
            if (compareBtn) compareBtn.style.display = 'none';
            
            // Clear error messages
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) errorMessage.style.display = 'none';
            
            // Reset current essay
            currentEssay = null;
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }
}
        
        function updateSliderPosition() {
            const translateX = -100 * currentPosition;
            document.getElementById('comparisonSlider').style.transform = `translateX(${translateX}%)`;
            
            // Update arrow states
            const leftArrow = document.getElementById('leftArrow');
            const rightArrow = document.getElementById('rightArrow');
            
            leftArrow.style.opacity = currentPosition === 0 ? '0.3' : '1';
            rightArrow.style.opacity = currentPosition >= totalPanels - 1 ? '0.3' : '1';
            
            // Update navigation info
            if (currentEssay) {
                const slider = document.getElementById('comparisonSlider');
                const panels = Array.from(slider.children);
                const panelInfo = [];
                
                // Reconstruct panel info
                let draftIndex = 0;
                for (let i = 0; i < panels.length; i++) {
                    if (i % 2 === 0) { // Draft panel
                        panelInfo.push({ type: 'draft', index: draftIndex });
                        draftIndex++;
                    } else { // Diff panel
                        panelInfo.push({ type: 'diff', fromIndex: draftIndex - 1, toIndex: draftIndex });
                    }
                }
                
                updateNavigationInfo(panelInfo);
            }
            // At the end of updateSliderPosition function
            // Enable annotations for diff panels
            setTimeout(() => {
                const panelInfo = getPanelInfo();
                const currentPanelInfo = panelInfo[currentPosition];
                
                if (currentPanelInfo && currentPanelInfo.type === 'diff' && currentEssay) {
                    makeAnnotatable(
                        currentEssay.title,
                        currentEssay.drafts[currentPanelInfo.fromIndex].version,
                        currentEssay.drafts[currentPanelInfo.toIndex].version
                    );
                }
            }, 100);

            if (currentEssay) {
        saveState();
    }
        }
        
        function switchTab(activeTabId, activeContentId) {
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.getElementById(activeTabId).classList.add('active');
            document.getElementById(activeContentId).classList.add('active');
        }
        
        // Wait for DOM to be loaded
        // Wait for DOM to be loaded
document.addEventListener('DOMContentLoaded', function() {

     // Load saved data
     loadAnnotations();
    
    // Show restore banner if there's saved data
    showRestoreBanner();
    
    // Clear data button
    const clearDataButton = document.getElementById('clearDataButton');
    if (clearDataButton) {
        clearDataButton.addEventListener('click', clearAllData);
    }
  
    // Tab switching
    document.getElementById('uploadTab').addEventListener('click', function() {
        switchTab('uploadTab', 'uploadContent');
    });
    
    document.getElementById('examplesTab').addEventListener('click', function() {
        switchTab('examplesTab', 'examplesContent');
    });

    // About modal functionality
    const aboutButton = document.getElementById('aboutButton');
    const aboutModal = document.getElementById('aboutModal');
    const aboutModalClose = document.getElementById('aboutModalClose');

    aboutButton.addEventListener('click', function() {
        aboutModal.style.display = 'block';
    });

    aboutModalClose.addEventListener('click', function() {
        aboutModal.style.display = 'none';
    });

    // File upload event listeners
    const fileInput = document.getElementById('fileInput');
    const fileInputContainer = document.querySelector('.file-input-container');
    const compareFilesBtn = document.getElementById('compareFiles');

    fileInput.addEventListener('change', function(e) {
        handleFileUpload(e.target.files);
    });

    // Drag and drop functionality
    fileInputContainer.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--primary-color)';
        this.style.backgroundColor = 'rgba(87, 6, 140, 0.05)';
    });

    fileInputContainer.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--accent-light)';
        this.style.backgroundColor = 'transparent';
    });

    fileInputContainer.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--accent-light)';
        this.style.backgroundColor = 'transparent';
        handleFileUpload(e.dataTransfer.files);
    });

    compareFilesBtn.addEventListener('click', compareUploadedFiles);
                
    // Example essay functionality
    const exampleCards = document.querySelectorAll('.example-card');
    exampleCards.forEach(card => {
        const analyzeBtn = card.querySelector('.example-btn');
        
        analyzeBtn.addEventListener('click', function() {
            const essayId = card.getAttribute('data-essay');
            loadExampleEssay(essayId);
        });
    });
    
    // Navigation arrows
    document.getElementById('leftArrow').addEventListener('click', function() {
        if (currentPosition > 0) {
            currentPosition--;
            updateSliderPosition();
        }
    });
    
    document.getElementById('rightArrow').addEventListener('click', function() {
        if (currentPosition < totalPanels - 1) {
            currentPosition++;
            updateSliderPosition();
        }
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (document.getElementById('comparisonResults').style.display !== 'none') {
            if (e.key === 'ArrowLeft' && currentPosition > 0) {
                currentPosition--;
                updateSliderPosition();
            } else if (e.key === 'ArrowRight' && currentPosition < totalPanels - 1) {
                currentPosition++;
                updateSliderPosition();
            }
        }
    });

    // Revision Report Modal functionality
    const reportModal = document.getElementById('revisionReportModal');
    const reportModalClose = document.getElementById('reportModalClose');
    
    if (reportModalClose) {
        reportModalClose.addEventListener('click', function() {
            reportModal.style.display = 'none';
        });
    }
    
    // Annotations Modal functionality
    const annotationsModal = document.getElementById('annotationsModal');
    const annotationsModalClose = document.getElementById('annotationsModalClose');
    
    if (annotationsModalClose) {
        annotationsModalClose.addEventListener('click', function() {
            annotationsModal.style.display = 'none';
        });
    }
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === aboutModal) {
            aboutModal.style.display = 'none';
        }
        if (event.target === reportModal) {
            reportModal.style.display = 'none';
        }
        if (event.target === annotationsModal) {
            annotationsModal.style.display = 'none';
        }
    });

    // Add this section in DOMContentLoaded, after the annotations modal setup:

    // PDF Options Modal
    const pdfOptionsModal = document.getElementById('pdfOptionsModal');
    const pdfOptionsClose = document.getElementById('pdfOptionsClose');
    const generatePdfBtn = document.getElementById('generatePdfBtn');
    const pdfCancelBtn = document.getElementById('pdfCancelBtn');
    
    if (pdfOptionsClose) {
        pdfOptionsClose.addEventListener('click', function() {
            pdfOptionsModal.style.display = 'none';
        });
    }
    
    if (generatePdfBtn) {
        generatePdfBtn.addEventListener('click', exportToPdf);
    }
    
    if (pdfCancelBtn) {
        pdfCancelBtn.addEventListener('click', function() {
            pdfOptionsModal.style.display = 'none';
        });
    }
    
    // Close PDF modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === pdfOptionsModal) {
            pdfOptionsModal.style.display = 'none';
        }
    });
    
    // Toggle between table and detail view for revision report
    const tableViewBtn = document.getElementById('tableViewBtn');
    const detailViewBtn = document.getElementById('detailViewBtn');
    
    if (tableViewBtn) {
        tableViewBtn.addEventListener('click', function() {
            this.classList.add('active');
            detailViewBtn.classList.remove('active');
            
            const currentPanel = document.querySelector('.comparison-slider').children[currentPosition];
            if (currentPanel && currentPanel.classList.contains('diff-panel')) {
                const diffContent = currentPanel.querySelector('.panel-content').innerHTML;
                const analysis = analyzeRevisions(diffContent);
                document.getElementById('reportContent').innerHTML = generateTableView(analysis);
            }
        });
    }
    
    if (detailViewBtn) {
        detailViewBtn.addEventListener('click', function() {
            this.classList.add('active');
            tableViewBtn.classList.remove('active');
            
            const currentPanel = document.querySelector('.comparison-slider').children[currentPosition];
            if (currentPanel && currentPanel.classList.contains('diff-panel')) {
                const diffContent = currentPanel.querySelector('.panel-content').innerHTML;
                const analysis = analyzeRevisions(diffContent);
                document.getElementById('reportContent').innerHTML = generateDetailedView(analysis);
            }
        });
    }
    
    // Add generate report button to the diff panels
    const addReportButton = () => {
        const comparisonResults = document.getElementById('comparisonResults');
        if (comparisonResults && !document.getElementById('generateReportBtn')) {
            const btn = document.createElement('button');
            btn.id = 'generateReportBtn';
            btn.className = 'generate-report-btn';
            btn.textContent = 'Generate Revision Report';
            btn.onclick = generateRevisionReport;
            comparisonResults.appendChild(btn);
        }
    };
    
// Add view annotations button
const addAnnotationsButton = () => {
    const comparisonResults = document.getElementById('comparisonResults');
    if (comparisonResults && !document.getElementById('viewAnnotationsBtn')) {
        const btn = document.createElement('button');
        btn.id = 'viewAnnotationsBtn';
        btn.className = 'view-annotations-btn';
        btn.textContent = 'View Annotations';
        btn.onclick = displayAnnotations;
        comparisonResults.appendChild(btn);
    }
};

// ADD THIS NEW FUNCTION HERE:
const addPdfExportButton = () => {
    const comparisonResults = document.getElementById('comparisonResults');
    if (comparisonResults && !document.getElementById('exportPdfBtn')) {
        const btn = document.createElement('button');
        btn.id = 'exportPdfBtn';
        btn.className = 'export-pdf-btn';
        btn.textContent = '📄 Export as PDF';
        btn.onclick = showPdfOptions;
        comparisonResults.appendChild(btn);
    }
};

// Check periodically if comparison results are shown
const observer = new MutationObserver(() => {
    if (document.getElementById('comparisonResults').style.display !== 'none') {
        addReportButton();
        addAnnotationsButton();
        addPdfExportButton();  // <-- Make sure this line is here!
    }
});

observer.observe(document.getElementById('comparisonResults'), {
    attributes: true,
    attributeFilter: ['style']
})});

        // Data structure to store revision analysis
        let revisionAnalysis = {
            additions: { word: [], phrase: [], sentence: [], paragraph: [] },
            deletions: { word: [], phrase: [], sentence: [], paragraph: [] }
        };






// Enhanced Data Persistence System
let annotations = {};
let savedState = null;

// Save state to localStorage
function saveState() {
    try {
        const state = {
            currentEssay: currentEssay,
            currentPosition: currentPosition,
            uploadedFiles: uploadedFiles.map(file => ({
                name: file.name,
                type: file.type,
                size: file.size
            })),
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('revisionToolState', JSON.stringify(state));
        showDataStatus('State saved ✓');
    } catch (e) {
        console.error('Error saving state:', e);
        if (e.name === 'QuotaExceededError') {
            showDataStatus('Storage full - please clear old data', true);
        }
    }
}

// Save file contents to localStorage
async function saveFileContents(files) {
    try {
        const fileData = [];
        
        for (let file of files) {
            const content = await readFileContent(file);
            fileData.push({
                name: file.name,
                type: file.type,
                content: content,
                size: file.size
            });
        }
        
        localStorage.setItem('revisionToolFiles', JSON.stringify(fileData));
        showDataStatus('Files saved ✓');
    } catch (e) {
        console.error('Error saving files:', e);
        if (e.name === 'QuotaExceededError') {
            showDataStatus('Files too large for storage', true);
        }
    }
}

// Load file contents from localStorage
function loadFileContents() {
    try {
        const stored = localStorage.getItem('revisionToolFiles');
        if (stored) {
            return JSON.parse(stored);
        }
    } catch (e) {
        console.error('Error loading files:', e);
    }
    return null;
}

// Load state from localStorage
function loadState() {
    try {
        const stored = localStorage.getItem('revisionToolState');
        if (stored) {
            savedState = JSON.parse(stored);
            return savedState;
        }
    } catch (e) {
        console.error('Error loading state:', e);
    }
    return null;
}

// Load annotations from localStorage
function loadAnnotations() {
    try {
        const stored = localStorage.getItem('revisionAnnotations');
        if (stored) {
            annotations = JSON.parse(stored);
        }
    } catch (e) {
        console.error('Error loading annotations:', e);
        annotations = {};
    }
}

// Save annotations to localStorage
function saveAnnotations() {
    try {
        localStorage.setItem('revisionAnnotations', JSON.stringify(annotations));
        showDataStatus('Annotations saved ✓');
    } catch (e) {
        console.error('Error saving annotations:', e);
    }
}

// Show data status message
function showDataStatus(message, isError = false) {
    const statusEl = document.getElementById('dataStatus');
    if (!statusEl) return;
    
    statusEl.textContent = message;
    statusEl.style.borderColor = isError ? '#dc3545' : 'var(--primary-color)';
    statusEl.style.color = isError ? '#dc3545' : 'var(--primary-dark)';
    statusEl.classList.add('show');
    
    setTimeout(() => {
        statusEl.classList.remove('show');
    }, 3000);
}

// Show restore banner
function showRestoreBanner() {
    const state = loadState();
    const files = loadFileContents();
    
    if (!state && !files) return;
    
    const container = document.querySelector('.container');
    const banner = document.createElement('div');
    banner.className = 'restore-banner';
    banner.id = 'restoreBanner';
    
    let message = 'Previous session found! ';
    if (state && state.currentEssay) {
        const date = new Date(state.timestamp).toLocaleString();
        message += `You were working on "${state.currentEssay.title}" (${date}).`;
    } else if (files) {
        message += `You have ${files.length} saved file(s).`;
    }
    
    banner.innerHTML = `
        <h4>🔄 Resume Previous Session?</h4>
        <p>${message}</p>
        <div class="restore-banner-buttons">
            <button class="restore-btn" id="restoreSession">Restore Session</button>
            <button class="dismiss-btn" id="dismissRestore">Start Fresh</button>
        </div>
    `;
    
    container.insertBefore(banner, container.firstChild);
    
    // Restore button
    document.getElementById('restoreSession').addEventListener('click', async function() {
        await restoreSession();
        banner.remove();
    });
    
    // Dismiss button
    document.getElementById('dismissRestore').addEventListener('click', function() {
        banner.remove();
    });
}

// Restore previous session
async function restoreSession() {
    const state = loadState();
    const files = loadFileContents();
    
    if (!state && !files) {
        showDataStatus('No saved session found', true);
        return;
    }
    
    // Show loading
    document.getElementById('loadingSpinner').style.display = 'flex';
    
    try {
        if (state && state.currentEssay) {
            currentEssay = state.currentEssay;
            
            // Hide upload section
            const uploadSection = document.querySelector('.upload-section');
            if (uploadSection) uploadSection.classList.add('hidden');
            
            // Recreate panels
            const panelInfo = createPanels(currentEssay);
            totalPanels = panelInfo.length;
            currentPosition = state.currentPosition || 0;
            
            // Show comparison results
            const comparisonResults = document.getElementById('comparisonResults');
            comparisonResults.style.display = 'block';
            updateSliderPosition();
            updateNavigationInfo(panelInfo);
            
            setupNewComparisonButton();
            
            showDataStatus('Session restored! ✓');
        } else if (files && files.length > 0) {
            // Restore uploaded files
            uploadedFiles = files;
            
            // Show file list
            const fileList = document.getElementById('fileList');
            const compareBtn = document.getElementById('compareFiles');
            
            fileList.innerHTML = '';
            files.forEach(fileData => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>
                        <div class="file-name">${fileData.name}</div>
                        <div class="file-size">${(fileData.size / 1024).toFixed(1)} KB</div>
                    </div>
                    <button class="remove-file" onclick="removeRestoredFile('${fileData.name}')">×</button>
                `;
                fileList.appendChild(fileItem);
            });
            
            fileList.style.display = 'block';
            if (files.length >= 2) {
                compareBtn.style.display = 'block';
            }
            
            showDataStatus(`${files.length} file(s) restored ✓`);
        }
    } catch (error) {
        console.error('Error restoring session:', error);
        showDataStatus('Error restoring session', true);
    } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
    }
}

// Remove restored file
window.removeRestoredFile = function(fileName) {
    uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
    
    const fileList = document.getElementById('fileList');
    const compareBtn = document.getElementById('compareFiles');
    
    fileList.innerHTML = '';
    
    if (uploadedFiles.length === 0) {
        fileList.style.display = 'none';
        compareBtn.style.display = 'none';
        localStorage.removeItem('revisionToolFiles');
    } else {
        uploadedFiles.forEach(fileData => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div>
                    <div class="file-name">${fileData.name}</div>
                    <div class="file-size">${(fileData.size / 1024).toFixed(1)} KB</div>
                </div>
                <button class="remove-file" onclick="removeRestoredFile('${fileData.name}')">×</button>
            `;
            fileList.appendChild(fileItem);
        });
        compareBtn.style.display = uploadedFiles.length >= 2 ? 'block' : 'none';
        saveFileContents(uploadedFiles);
    }
};

// Clear all saved data
function clearAllData() {
    if (confirm('Clear all saved data? This will remove your saved files, annotations, and session state.')) {
        localStorage.removeItem('revisionToolState');
        localStorage.removeItem('revisionToolFiles');
        localStorage.removeItem('revisionAnnotations');
        annotations = {};
        savedState = null;
        showDataStatus('All data cleared ✓');
        
        // Reload page
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    }
}

// Generate unique ID for annotation based on essay, drafts, and text
function getAnnotationId(essayTitle, fromDraft, toDraft, text) {
    const cleanText = text.substring(0, 50).trim();
    return `${essayTitle}|${fromDraft}|${toDraft}|${cleanText}`;
}

// Show annotation popup
// Show annotation popup (REPLACE ENTIRE FUNCTION)
function showAnnotationPopup(element, annotationId, existingNote = '') {
    // Remove any existing popup
    const existingPopup = document.querySelector('.annotation-popup');
    if (existingPopup) {
        existingPopup.remove();
    }

    const popup = document.createElement('div');
    popup.className = 'annotation-popup';
    
    popup.innerHTML = `
        <h4>Add Annotation</h4>
        <textarea id="annotationText" placeholder="Why did you make this change? What were you trying to achieve?">${existingNote}</textarea>
        <div class="annotation-popup-buttons">
            <button class="annotation-save-btn" id="saveAnnotation">Save</button>
            <button class="annotation-cancel-btn" id="cancelAnnotation">Cancel</button>
            ${existingNote ? '<button class="annotation-delete-btn" id="deleteAnnotation">Delete</button>' : ''}
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // Smart positioning - calculate after adding to DOM so we know popup dimensions
    const rect = element.getBoundingClientRect();
    const popupRect = popup.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const viewportWidth = window.innerWidth;
    const scrollY = window.scrollY;
    const scrollX = window.scrollX;
    
    // Determine vertical position
    let top;
    const spaceBelow = viewportHeight - rect.bottom;
    const spaceAbove = rect.top;
    
    if (spaceBelow >= popupRect.height + 20) {
        // Enough space below - place it below the element
        top = rect.bottom + scrollY + 10;
    } else if (spaceAbove >= popupRect.height + 20) {
        // Not enough space below but enough above - place it above
        top = rect.top + scrollY - popupRect.height - 10;
    } else {
        // Not enough space either way - center it vertically in viewport
        top = scrollY + (viewportHeight - popupRect.height) / 2;
    }
    
    // Determine horizontal position
    let left = rect.left + scrollX;
    
    // Make sure popup doesn't go off right edge
    if (left + popupRect.width > viewportWidth + scrollX) {
        left = viewportWidth + scrollX - popupRect.width - 20;
    }
    
    // Make sure popup doesn't go off left edge
    if (left < scrollX + 20) {
        left = scrollX + 20;
    }
    
    popup.style.position = 'absolute';
    popup.style.left = `${left}px`;
    popup.style.top = `${top}px`;
    
    // Focus textarea
    const textarea = popup.querySelector('#annotationText');
    textarea.focus();
    
    // Save button
    document.getElementById('saveAnnotation').onclick = function() {
        const note = textarea.value.trim();
        if (note) {
            annotations[annotationId] = {
                note: note,
                text: element.textContent,
                timestamp: new Date().toISOString()
            };
            saveAnnotations();
            element.classList.add('has-annotation');
            popup.remove();
        }
    };
    
    // Cancel button
    document.getElementById('cancelAnnotation').onclick = function() {
        popup.remove();
    };
    
    // Delete button
    const deleteBtn = document.getElementById('deleteAnnotation');
    if (deleteBtn) {
        deleteBtn.onclick = function() {
            delete annotations[annotationId];
            saveAnnotations();
            element.classList.remove('has-annotation');
            popup.remove();
        };
    }
    
    // Close on click outside
    setTimeout(() => {
        document.addEventListener('click', function closePopup(e) {
            if (!popup.contains(e.target) && e.target !== element) {
                popup.remove();
                document.removeEventListener('click', closePopup);
            }
        });
    }, 100);
}

// Make diff elements annotatable
function makeAnnotatable(essayTitle, fromDraft, toDraft) {
    const diffPanel = document.querySelector('.comparison-slider').children[currentPosition];
    if (!diffPanel || !diffPanel.classList.contains('diff-panel')) return;
    
    const additions = diffPanel.querySelectorAll('.addition');
    const deletions = diffPanel.querySelectorAll('.deletion');
    
    [...additions, ...deletions].forEach(element => {
        const text = element.textContent;
        const annotationId = getAnnotationId(essayTitle, fromDraft, toDraft, text);
        
        element.classList.add('annotatable');
        
        // Check if annotation exists
        if (annotations[annotationId]) {
            element.classList.add('has-annotation');
        }
        
        element.onclick = function(e) {
            e.stopPropagation();
            const existingNote = annotations[annotationId]?.note || '';
            showAnnotationPopup(element, annotationId, existingNote);
        };
    });
}

// Display all annotations for current comparison
function displayAnnotations() {
    const modal = document.getElementById('annotationsModal');
    const content = document.getElementById('annotationsContent');
    
    if (!currentEssay) {
        content.innerHTML = '<p>No essay loaded.</p>';
        modal.style.display = 'block';
        return;
    }
    
    const currentPanel = document.querySelector('.comparison-slider').children[currentPosition];
    if (!currentPanel || !currentPanel.classList.contains('diff-panel')) {
        content.innerHTML = '<p>Navigate to a changes view to see annotations.</p>';
        modal.style.display = 'block';
        return;
    }
    
    // Get current draft info
    const panelInfo = getPanelInfo();
    const panel = panelInfo[currentPosition];
    
    if (panel.type !== 'diff') {
        content.innerHTML = '<p>Navigate to a changes view to see annotations.</p>';
        modal.style.display = 'block';
        return;
    }
    
    const fromDraft = currentEssay.drafts[panel.fromIndex].version;
    const toDraft = currentEssay.drafts[panel.toIndex].version;
    
    // Find relevant annotations
    const relevantAnnotations = Object.entries(annotations).filter(([id]) => {
        return id.startsWith(`${currentEssay.title}|${fromDraft}|${toDraft}`);
    });
    
    if (relevantAnnotations.length === 0) {
        content.innerHTML = `
            <div class="annotations-panel">
                <p>No annotations yet for this comparison.</p>
                <p style="margin-top: 10px; color: #666;">
                    <strong>Tip:</strong> Click on any highlighted addition or deletion in the changes view to add an annotation.
                </p>
            </div>
        `;
    } else {
        let html = `<div class="annotations-panel">
            <p style="margin-bottom: 20px; color: #666;">
                Showing ${relevantAnnotations.length} annotation(s) for ${fromDraft} → ${toDraft}
            </p>`;
        
        relevantAnnotations.forEach(([id, data]) => {
            html += `
                <div class="annotation-item">
                    <div class="annotation-item-header">Revised text:</div>
                    <div class="annotation-item-text">"${data.text.substring(0, 100)}${data.text.length > 100 ? '...' : ''}"</div>
                    <div class="annotation-item-header">Your note:</div>
                    <div class="annotation-item-note">${data.note}</div>
                    <div style="margin-top: 8px; font-size: 0.85rem; color: #999;">
                        ${new Date(data.timestamp).toLocaleString()}
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        content.innerHTML = html;
    }
    
    modal.style.display = 'block';
}

// PDF Export Functions

function showPdfOptions() {
    const currentPanel = document.querySelector('.comparison-slider').children[currentPosition];
    
    if (!currentEssay && !currentPanel) {
        alert('Please load an essay or upload files first.');
        return;
    }
    
    // Show modal
    document.getElementById('pdfOptionsModal').style.display = 'block';
    
    // Make options mutually exclusive for all drafts vs current only
    const allDraftsCheckbox = document.getElementById('includeAllDrafts');
    const currentOnlyCheckbox = document.getElementById('includeCurrentOnly');
    
    allDraftsCheckbox.onchange = function() {
        if (this.checked) {
            currentOnlyCheckbox.checked = false;
        }
    };
    
    currentOnlyCheckbox.onchange = function() {
        if (this.checked) {
            allDraftsCheckbox.checked = false;
        } else {
            allDraftsCheckbox.checked = true;
        }
    };
}

function generatePrintableContent() {
    const includeAllDrafts = document.getElementById('includeAllDrafts').checked;
    const includeCurrentOnly = document.getElementById('includeCurrentOnly').checked;
    const includeAnnotations = document.getElementById('includeAnnotations').checked;
    const includeLegend = document.getElementById('includeLegend').checked;
    
    const printableDiv = document.getElementById('printableContent');
    let html = '';
    
    // Add title
    if (currentEssay) {
        html += `<div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #57068c; margin-bottom: 10px;">${currentEssay.title}</h1>
            <p style="color: #666; font-style: italic;">${currentEssay.author}</p>
            <p style="color: #999; font-size: 0.9em;">Generated on ${new Date().toLocaleString()}</p>
        </div>`;
    }
    
    // Add legend
    if (includeLegend) {
        html += `<div class="print-legend">
            <h3>Color Legend</h3>
            <p><span class="deletion word-level">Deleted text</span> - Text removed from previous draft</p>
            <p><span class="addition word-level">Added text</span> - Text added in revision</p>
            ${includeAnnotations ? '<p><span class="has-annotation">Annotated text 📝</span> - Text with revision notes</p>' : ''}
        </div>`;
    }
    
    if (includeCurrentOnly) {
        // Export only current view
        const currentPanel = document.querySelector('.comparison-slider').children[currentPosition];
        const panelInfo = getPanelInfo();
        const currentPanelInfo = panelInfo[currentPosition];
        
        if (currentPanelInfo.type === 'draft') {
            html += generateDraftForPrint(currentEssay.drafts[currentPanelInfo.index]);
        } else if (currentPanelInfo.type === 'diff') {
            html += generateDiffForPrint(
                currentEssay.drafts[currentPanelInfo.fromIndex],
                currentEssay.drafts[currentPanelInfo.toIndex],
                currentPanel,
                includeAnnotations
            );
        }
    } else if (includeAllDrafts) {
        // Export all drafts
        const slider = document.getElementById('comparisonSlider');
        const panels = Array.from(slider.children);
        const panelInfo = getPanelInfo();
        
        panelInfo.forEach((info, index) => {
            if (info.type === 'draft') {
                html += generateDraftForPrint(currentEssay.drafts[info.index]);
            } else if (info.type === 'diff') {
                html += generateDiffForPrint(
                    currentEssay.drafts[info.fromIndex],
                    currentEssay.drafts[info.toIndex],
                    panels[index],
                    includeAnnotations
                );
            }
        });
    }
    
    printableDiv.innerHTML = html;
}

function generateDraftForPrint(draft) {
    return `
        <div class="panel" style="margin-bottom: 40px; padding: 20px;">
            <h2 style="color: #57068c; border-bottom: 2px solid #57068c; padding-bottom: 10px;">${draft.version}</h2>
            <div class="panel-content" style="margin-top: 20px; line-height: 1.8;">
                ${formatText(draft.text)}
            </div>
        </div>
    `;
}

function generateDiffForPrint(fromDraft, toDraft, panelElement, includeAnnotations) {
    let html = `
        <div class="panel diff-panel" style="margin-bottom: 40px; padding: 20px; background-color: #fafafa;">
            <h2 style="color: #57068c; border-bottom: 2px solid #57068c; padding-bottom: 10px;">
                Changes: ${fromDraft.version} → ${toDraft.version}
            </h2>
            <div class="panel-content" style="margin-top: 20px; line-height: 1.8;">
    `;
    
    // Get the diff content from the panel
    const diffContent = panelElement.querySelector('.panel-content').innerHTML;
    html += diffContent;
    
    // Add annotations if requested
    if (includeAnnotations) {
        const relevantAnnotations = getAnnotationsForDiff(fromDraft.version, toDraft.version);
        
        if (relevantAnnotations.length > 0) {
            html += `
                <div style="margin-top: 40px; page-break-before: avoid;">
                    <h3 style="color: #57068c; border-bottom: 1px solid #57068c; padding-bottom: 5px;">
                        Revision Notes
                    </h3>
            `;
            
            relevantAnnotations.forEach(([id, data]) => {
                html += `
                    <div class="annotation-in-print">
                        <div class="annotation-in-print-header">📝 "${data.text.substring(0, 80)}${data.text.length > 80 ? '...' : ''}"</div>
                        <div class="annotation-in-print-text">${data.note}</div>
                    </div>
                `;
            });
            
            html += '</div>';
        }
    }
    
    html += '</div></div>';
    return html;
}

function getAnnotationsForDiff(fromDraft, toDraft) {
    if (!currentEssay) return [];
    
    return Object.entries(annotations).filter(([id]) => {
        return id.startsWith(`${currentEssay.title}|${fromDraft}|${toDraft}`);
    });
}

function exportToPdf() {
    // Generate the content
    generatePrintableContent();
    
    // Show the printable content temporarily
    const printableDiv = document.getElementById('printableContent');
    printableDiv.style.display = 'block';
    
    // Close the modal
    document.getElementById('pdfOptionsModal').style.display = 'none';
    
    // Small delay to ensure content is rendered
    setTimeout(() => {
        // Trigger print dialog
        window.print();
        
        // Hide printable content after printing
        setTimeout(() => {
            printableDiv.style.display = 'none';
        }, 500);
    }, 250);
}

// Helper function to get panel info
function getPanelInfo() {
    const slider = document.getElementById('comparisonSlider');
    const panels = Array.from(slider.children);
    const panelInfo = [];
    
    let draftIndex = 0;
    for (let i = 0; i < panels.length; i++) {
        if (i % 2 === 0) {
            panelInfo.push({ type: 'draft', index: draftIndex });
            draftIndex++;
        } else {
            panelInfo.push({ type: 'diff', fromIndex: draftIndex - 1, toIndex: draftIndex });
        }
    }
    
    return panelInfo;
}

// Helper function to get panel info
function getPanelInfo() {
    const slider = document.getElementById('comparisonSlider');
    const panels = Array.from(slider.children);
    const panelInfo = [];
    
    let draftIndex = 0;
    for (let i = 0; i < panels.length; i++) {
        if (i % 2 === 0) {
            panelInfo.push({ type: 'draft', index: draftIndex });
            draftIndex++;
        } else {
            panelInfo.push({ type: 'diff', fromIndex: draftIndex - 1, toIndex: draftIndex });
        }
    }
    
    return panelInfo;
}


// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Replace the existing analyzeRevisions function and related code with this enhanced version

// Enhanced revision analysis with better categorization
function analyzeRevisions(diffHtml) {
    const analysis = {
        additions: {
            micro: [],      // 1-2 words (punctuation, articles, minor word changes)
            small: [],      // 3-10 words (phrases, short additions)
            medium: [],     // 11-50 words (sentences, substantial phrases)
            large: [],      // 51-150 words (paragraphs)
            massive: []     // 150+ words (multiple paragraphs, major sections)
        },
        deletions: {
            micro: [],
            small: [],
            medium: [],
            large: [],
            massive: []
        },
        statistics: {
            totalChanges: 0,
            totalWordsAdded: 0,
            totalWordsDeleted: 0,
            netWordChange: 0,
            revisionIntensity: 0  // Percentage of text that changed
        },
        patterns: {
            surfaceEdits: 0,      // Micro changes (likely copyediting)
            substantiveEdits: 0,   // Small-medium changes
            structuralChanges: 0,  // Large-massive changes
            balanceScore: 0        // Ratio of additions to deletions
        }
    };
    
    // Parse the diff HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = diffHtml;
    
    // Process additions
    const additions = tempDiv.querySelectorAll('.addition');
    additions.forEach(span => {
        const text = span.textContent;
        const category = categorizeRevision(text);
        const wordCount = countWords(text);
        
        analysis.additions[category].push({
            text: text,
            wordCount: wordCount,
            charCount: text.length
        });
        analysis.statistics.totalWordsAdded += wordCount;
    });
    
    // Process deletions
    const deletions = tempDiv.querySelectorAll('.deletion');
    deletions.forEach(span => {
        const text = span.textContent;
        const category = categorizeRevision(text);
        const wordCount = countWords(text);
        
        analysis.deletions[category].push({
            text: text,
            wordCount: wordCount,
            charCount: text.length
        });
        analysis.statistics.totalWordsDeleted += wordCount;
    });
    
    // Calculate statistics
    analysis.statistics.totalChanges = additions.length + deletions.length;
    analysis.statistics.netWordChange = analysis.statistics.totalWordsAdded - analysis.statistics.totalWordsDeleted;
    
    // Calculate revision patterns
    calculateRevisionPatterns(analysis);
    
    // Calculate revision intensity
    const totalText = tempDiv.textContent;
    const unchangedText = totalText.replace(/<[^>]*>/g, '');
    if (unchangedText.length > 0) {
        const changedChars = Array.from(additions).reduce((sum, el) => sum + el.textContent.length, 0) +
                           Array.from(deletions).reduce((sum, el) => sum + el.textContent.length, 0);
        analysis.statistics.revisionIntensity = Math.round((changedChars / unchangedText.length) * 100);
    }
    
    return analysis;
}

// Categorize revision by size
function categorizeRevision(text) {
    const wordCount = countWords(text);
    
    if (wordCount <= 2) return 'micro';
    if (wordCount <= 10) return 'small';
    if (wordCount <= 50) return 'medium';
    if (wordCount <= 150) return 'large';
    return 'massive';
}

// Count words accurately
function countWords(text) {
    const words = text.trim().match(/\b\w+(?:'\w+)?\b/g);
    return words ? words.length : 0;
}

// Calculate revision patterns
function calculateRevisionPatterns(analysis) {
    const categories = ['micro', 'small', 'medium', 'large', 'massive'];
    
    // Count surface edits (micro changes)
    analysis.patterns.surfaceEdits = 
        analysis.additions.micro.length + analysis.deletions.micro.length;
    
    // Count substantive edits (small and medium)
    analysis.patterns.substantiveEdits = 
        analysis.additions.small.length + analysis.deletions.small.length +
        analysis.additions.medium.length + analysis.deletions.medium.length;
    
    // Count structural changes (large and massive)
    analysis.patterns.structuralChanges = 
        analysis.additions.large.length + analysis.deletions.large.length +
        analysis.additions.massive.length + analysis.deletions.massive.length;
    
    // Calculate balance score
    const totalAdditions = categories.reduce((sum, cat) => sum + analysis.additions[cat].length, 0);
    const totalDeletions = categories.reduce((sum, cat) => sum + analysis.deletions[cat].length, 0);
    
    if (totalDeletions > 0) {
        analysis.patterns.balanceScore = (totalAdditions / totalDeletions).toFixed(2);
    } else if (totalAdditions > 0) {
        analysis.patterns.balanceScore = "∞"; // All additions, no deletions
    } else {
        analysis.patterns.balanceScore = "0";
    }
}

// Generate enhanced table view with quantitative analysis
function generateEnhancedTableView(analysis) {
    const categories = [
        { key: 'micro', label: 'Micro (1-2 words)', description: 'Punctuation, articles, minor adjustments' },
        { key: 'small', label: 'Small (3-10 words)', description: 'Phrases, clarifications' },
        { key: 'medium', label: 'Medium (11-50 words)', description: 'Sentences, substantial additions' },
        { key: 'large', label: 'Large (51-150 words)', description: 'Paragraphs, major revisions' },
        { key: 'massive', label: 'Massive (150+ words)', description: 'Multiple paragraphs, new sections' }
    ];
    
    let html = `
        <!-- Summary Statistics -->
        <div class="stats-summary">
            <div class="stat-card">
                <div class="stat-number">${analysis.statistics.totalChanges}</div>
                <div class="stat-label">Total Changes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #2e7d32;">${analysis.statistics.totalWordsAdded}</div>
                <div class="stat-label">Words Added</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #c62828;">${analysis.statistics.totalWordsDeleted}</div>
                <div class="stat-label">Words Deleted</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: ${analysis.statistics.netWordChange >= 0 ? '#2e7d32' : '#c62828'};">
                    ${analysis.statistics.netWordChange > 0 ? '+' : ''}${analysis.statistics.netWordChange}
                </div>
                <div class="stat-label">Net Word Change</div>
            </div>
        </div>

        <!-- Revision Patterns -->
        <div style="margin: 30px 0; padding: 20px; background: #f0ecf8; border-radius: 8px;">
            <h3 style="color: var(--primary-dark); margin-bottom: 15px;">Revision Patterns</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                    <strong>Surface Edits:</strong> ${analysis.patterns.surfaceEdits} changes<br>
                    <small style="color: #666;">Minor word-level adjustments</small>
                </div>
                <div>
                    <strong>Substantive Edits:</strong> ${analysis.patterns.substantiveEdits} changes<br>
                    <small style="color: #666;">Meaningful phrase/sentence changes</small>
                </div>
                <div>
                    <strong>Structural Changes:</strong> ${analysis.patterns.structuralChanges} changes<br>
                    <small style="color: #666;">Major paragraph/section revisions</small>
                </div>
                <div>
                    <strong>Add/Delete Ratio:</strong> ${analysis.patterns.balanceScore}<br>
                    <small style="color: #666;">${interpretBalanceScore(analysis.patterns.balanceScore)}</small>
                </div>
            </div>
        </div>

        <!-- Detailed Breakdown Table -->
        <h3 style="color: var(--primary-dark); margin: 20px 0 10px 0;">Detailed Breakdown</h3>
        <table class="revision-table">
            <thead>
                <tr>
                    <th>Revision Size</th>
                    <th style="text-align: center;">Additions</th>
                    <th style="text-align: center;">Deletions</th>
                    <th style="text-align: center;">Total</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalAdditions = 0;
    let totalDeletions = 0;
    
    categories.forEach(cat => {
        const additions = analysis.additions[cat.key].length;
        const deletions = analysis.deletions[cat.key].length;
        const rowTotal = additions + deletions;
        
        totalAdditions += additions;
        totalDeletions += deletions;
        
        html += `
            <tr>
                <td class="row-label">${cat.label}</td>
                <td style="text-align: center; color: #2e7d32; font-weight: 600;">${additions}</td>
                <td style="text-align: center; color: #c62828; font-weight: 600;">${deletions}</td>
                <td style="text-align: center; font-weight: 700;">${rowTotal}</td>
                <td style="font-size: 0.85rem; color: #666;">${cat.description}</td>
            </tr>
        `;
    });
    
    // Totals row
    html += `
        <tr class="total-row">
            <td class="row-label"><strong>TOTAL</strong></td>
            <td style="text-align: center; font-weight: 700; color: #2e7d32;">${totalAdditions}</td>
            <td style="text-align: center; font-weight: 700; color: #c62828;">${totalDeletions}</td>
            <td style="text-align: center; font-weight: 700;">${totalAdditions + totalDeletions}</td>
            <td></td>
        </tr>
    `;
    
    html += '</tbody></table>';
    
    // Add interpretation
    html += generateQuantitativeInterpretation(analysis);
    
    // Add word frequency analysis if significant
    const wordFrequency = analyzeWordFrequency(analysis);
    if (wordFrequency.length > 0) {
        html += generateWordFrequencySection(wordFrequency);
    }
    
    return html;
}

// Interpret balance score
function interpretBalanceScore(score) {
    if (score === "∞") return "Pure expansion (no deletions)";
    if (score === "0") return "No changes detected";
    const numScore = parseFloat(score);
    if (numScore > 2) return "Heavy expansion";
    if (numScore > 1.2) return "More adding than cutting";
    if (numScore > 0.8) return "Balanced revision";
    if (numScore > 0.5) return "More cutting than adding";
    return "Heavy condensation";
}

// Generate quantitative interpretation
function generateQuantitativeInterpretation(analysis) {
    const totalChanges = analysis.statistics.totalChanges;
    const surfacePercent = Math.round((analysis.patterns.surfaceEdits / totalChanges) * 100) || 0;
    const substantivePercent = Math.round((analysis.patterns.substantiveEdits / totalChanges) * 100) || 0;
    const structuralPercent = Math.round((analysis.patterns.structuralChanges / totalChanges) * 100) || 0;
    
    let interpretation = `
        <div style="margin-top: 30px; padding: 25px; background: white; border-left: 4px solid var(--primary-color); border-radius: 8px;">
            <h3 style="color: var(--primary-dark); margin-bottom: 15px;">📊 Quantitative Analysis</h3>
    `;
    
    // Revision scope assessment
    interpretation += '<p><strong>Revision Scope:</strong> ';
    if (structuralPercent > 30) {
        interpretation += `This revision shows <span style="color: var(--primary-color); font-weight: 600;">major structural changes</span> with ${structuralPercent}% of edits at the paragraph level or larger. This suggests significant reconceptualization or reorganization of ideas.`;
    } else if (substantivePercent > 50) {
        interpretation += `This revision is <span style="color: var(--primary-color); font-weight: 600;">substantially revised</span> with ${substantivePercent}% of changes at the phrase/sentence level, indicating meaningful content refinement without major structural overhaul.`;
    } else if (surfacePercent > 60) {
        interpretation += `This revision is <span style="color: var(--primary-color); font-weight: 600;">primarily surface-level</span> with ${surfacePercent}% micro-edits. Consider whether deeper structural or conceptual changes might strengthen the work.`;
    } else {
        interpretation += `This revision shows a <span style="color: var(--primary-color); font-weight: 600;">mixed approach</span> with balanced changes across different scales.`;
    }
    interpretation += '</p>';
    
    // Net change assessment
    interpretation += '<p style="margin-top: 12px;"><strong>Content Evolution:</strong> ';
    const netChange = analysis.statistics.netWordChange;
    const percentChange = Math.abs(Math.round((netChange / (analysis.statistics.totalWordsDeleted || 1)) * 100));
    
    if (netChange > 100) {
        interpretation += `The text <span style="color: #2e7d32; font-weight: 600;">expanded significantly</span> by ${netChange} words. This expansion suggests development of ideas, addition of evidence, or elaboration of arguments.`;
    } else if (netChange < -100) {
        interpretation += `The text was <span style="color: #c62828; font-weight: 600;">condensed significantly</span> by ${Math.abs(netChange)} words. This suggests focused editing for clarity and concision.`;
    } else if (Math.abs(netChange) < 20) {
        interpretation += `The text length remained <span style="color: var(--primary-color); font-weight: 600;">relatively stable</span> (${netChange > 0 ? '+' : ''}${netChange} words), suggesting refinement rather than expansion or reduction.`;
    } else {
        interpretation += `The text ${netChange > 0 ? 'grew' : 'shrank'} by <span style="font-weight: 600;">${Math.abs(netChange)} words</span>, a moderate change suggesting targeted revision.`;
    }
    interpretation += '</p>';
    
    // Revision style
    interpretation += '<p style="margin-top: 12px;"><strong>Revision Style:</strong> ';
    const balanceScore = analysis.patterns.balanceScore;
    if (balanceScore === "∞" || parseFloat(balanceScore) > 3) {
        interpretation += 'This appears to be an <span style="color: var(--primary-color); font-weight: 600;">additive revision</span>, building upon the existing text with minimal removal of content.';
    } else if (parseFloat(balanceScore) < 0.5) {
        interpretation += 'This appears to be a <span style="color: var(--primary-color); font-weight: 600;">reductive revision</span>, focusing on cutting and condensing rather than adding new material.';
    } else {
        interpretation += 'This represents a <span style="color: var(--primary-color); font-weight: 600;">transformative revision</span> with substantial both additions and deletions, suggesting significant reworking.';
    }
    interpretation += '</p>';
    
    // Sommers reference
    if (surfacePercent > 60) {
        interpretation += `
            <div style="margin-top: 20px; padding: 15px; background: #fff8e1; border-radius: 5px;">
                <strong>💡 Research Insight:</strong> According to Nancy Sommers' research, expert writers tend to make more structural and conceptual revisions compared to novices who focus on surface-level changes. 
                With ${surfacePercent}% surface edits in this revision, consider reviewing the overall argument structure and paragraph organization for potential deeper improvements.
            </div>
        `;
    }
    
    interpretation += '</div>';
    return interpretation;
}

// Analyze word frequency in changes
function analyzeWordFrequency(analysis) {
    const wordCounts = {};
    const categories = ['small', 'medium', 'large', 'massive'];
    
    // Count word frequency in additions
    categories.forEach(cat => {
        analysis.additions[cat].forEach(item => {
            const words = item.text.toLowerCase().match(/\b\w+(?:'\w+)?\b/g) || [];
            words.forEach(word => {
                if (word.length > 4) { // Only count substantial words
                    wordCounts[word] = (wordCounts[word] || 0) + 1;
                }
            });
        });
    });
    
    // Sort and return top recurring terms
    return Object.entries(wordCounts)
        .filter(([word, count]) => count > 2)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
}

// Generate word frequency section
function generateWordFrequencySection(wordFrequency) {
    if (wordFrequency.length === 0) return '';
    
    let html = `
        <div style="margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <h3 style="color: var(--primary-dark); margin-bottom: 15px;">🔤 Key Terms in Revisions</h3>
            <p style="margin-bottom: 10px; color: #666;">Frequently added or modified terms (may indicate focus areas):</p>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
    `;
    
    wordFrequency.forEach(([word, count]) => {
        html += `
            <span style="
                background: white;
                padding: 5px 12px;
                border-radius: 20px;
                border: 1px solid var(--primary-color);
                color: var(--primary-dark);
                font-size: 0.9rem;
            ">
                <strong>${word}</strong> (${count}×)
            </span>
        `;
    });
    
    html += '</div></div>';
    return html;
}

// Update the main generateTableView function to use the enhanced version
function generateTableView(analysis) {
    return generateEnhancedTableView(analysis);
}

// Also enhance the detailed view
function generateDetailedView(analysis) {
    let html = '<div class="detail-list">';
    
    const categories = [
        { key: 'micro', label: 'Micro Changes', class: 'micro' },
        { key: 'small', label: 'Small Changes', class: 'small' },
        { key: 'medium', label: 'Medium Changes', class: 'medium' },
        { key: 'large', label: 'Large Changes', class: 'large' },
        { key: 'massive', label: 'Massive Changes', class: 'massive' }
    ];
    
    const types = [
        { key: 'additions', label: 'Additions', class: 'addition' },
        { key: 'deletions', label: 'Deletions', class: 'deletion' }
    ];
    
    types.forEach(type => {
        let typeHtml = `<div class="revision-category">
            <div class="category-title">${type.label}</div>`;
        let hasContent = false;
        
        categories.forEach(cat => {
            const items = analysis[type.key][cat.key];
            if (items.length > 0) {
                hasContent = true;
                typeHtml += `
                    <h4 style="margin-top: 15px; color: var(--primary-dark);">
                        ${cat.label} (${items.length} changes, ${items.reduce((sum, item) => sum + item.wordCount, 0)} words)
                    </h4>
                `;
                
                // Show first 3 examples of each category
                items.slice(0, 3).forEach(item => {
                    typeHtml += `
                        <div class="revision-item ${type.class}" style="margin: 10px 0;">
                            <div class="revision-text">
                                "${item.text.substring(0, 150)}${item.text.length > 150 ? '...' : ''}"
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                ${item.wordCount} words, ${item.charCount} characters
                            </div>
                        </div>
                    `;
                });
                
                if (items.length > 3) {
                    typeHtml += `<p style="color: #666; font-style: italic;">... and ${items.length - 3} more ${cat.label.toLowerCase()}</p>`;
                }
            }
        });
        
        typeHtml += '</div>';
        
        if (hasContent) {
            html += typeHtml;
        }
    });
    
    html += '</div>';
    return html;
}



// Replace the existing generateRevisionReport function with this updated version:
function generateRevisionReport() {
    const currentPanel = document.querySelector('.comparison-slider').children[currentPosition];
    
    // Check if current panel is a diff panel
    if (!currentPanel || !currentPanel.classList.contains('diff-panel')) {
        alert('Please navigate to a changes view (showing differences between drafts) to generate a report.');
        return;
    }
    
    const diffContent = currentPanel.querySelector('.panel-content').innerHTML;
    const analysis = analyzeRevisions(diffContent);
    
    // Show modal instead of container
    const modal = document.getElementById('revisionReportModal');
    if (modal) {
        modal.style.display = 'block';
        
        // Generate initial table view
        document.getElementById('reportContent').innerHTML = generateTableView(analysis);
    }
}

// Add event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize modal functionality
    const revisionReportModal = document.getElementById('revisionReportModal');
    const reportModalClose = document.getElementById('reportModalClose');
    
    if (reportModalClose) {
        reportModalClose.onclick = function() {
            revisionReportModal.style.display = 'none';
        }
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target === revisionReportModal) {
            revisionReportModal.style.display = 'none';
        }
    }
    
    // Add generate report button to the diff panels
    const addReportButton = () => {
        const comparisonResults = document.getElementById('comparisonResults');
        if (comparisonResults && !document.getElementById('generateReportBtn')) {
            const btn = document.createElement('button');
            btn.id = 'generateReportBtn';
            btn.className = 'generate-report-btn';
            btn.textContent = 'Generate Revision Report';
            btn.onclick = generateRevisionReport;
            comparisonResults.appendChild(btn);
        }
    };
    
    // Check periodically if comparison results are shown
    const observer = new MutationObserver(() => {
        if (document.getElementById('comparisonResults').style.display !== 'none') {
            addReportButton();
        }
    });
    
    observer.observe(document.getElementById('comparisonResults'), {
        attributes: true,
        attributeFilter: ['style']
    });
    
    // Toggle between table and detail view
    document.getElementById('tableViewBtn').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('detailViewBtn').classList.remove('active');
        
        const currentPanel = document.querySelector('.comparison-slider').children[currentPosition];
        if (currentPanel && currentPanel.classList.contains('diff-panel')) {
            const diffContent = currentPanel.querySelector('.panel-content').innerHTML;
            const analysis = analyzeRevisions(diffContent);
            document.getElementById('reportContent').innerHTML = generateTableView(analysis);
        }
    });
    
    document.getElementById('detailViewBtn').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('tableViewBtn').classList.remove('active');
        
        const currentPanel = document.querySelector('.comparison-slider').children[currentPosition];
        if (currentPanel && currentPanel.classList.contains('diff-panel')) {
            const diffContent = currentPanel.querySelector('.panel-content').innerHTML;
            const analysis = analyzeRevisions(diffContent);
            document.getElementById('reportContent').innerHTML = generateDetailedView(analysis);
        }
    });
});
    </script>
</body>
</html>
